# モジュール3: Microsoft Defender XDR によるセキュリティと脅威の管理 (試験比重: 35-40%)

## はじめに (モジュール3の学習を始めるにあたって)

このモジュールでは、Microsoft 365 環境におけるセキュリティと脅威管理の中核をなす Microsoft Defender XDR スイートについて学習します。メール、エンドポイント、ID、クラウドアプリケーションといった複数のドメインにまたがる脅威を検出し、対応するための統合的なアプローチを理解します。サイバー攻撃が高度化・巧妙化する現代において、組織の資産を守るための実践的なスキルを習得することが目標です。

**学習目標:**

* Microsoft Defender XDR のアーキテクチャと主要コンポーネントを理解する。
* Microsoft Secure Score を活用してセキュリティ体制を評価し、改善策を特定できる。
* Microsoft Defender for Office 365 を使用して、フィッシング、マルウェア、スパムなどのメールベースの脅威から組織を保護できる。
* Microsoft Defender for Endpoint を使用して、エンドポイントの脅威を検出し、調査し、対応できる。攻撃面の縮小や脆弱性管理を実装できる。
* Microsoft Defender for Cloud Apps を使用して、クラウドアプリケーションの利用状況を可視化し、シャドーIT対策や情報漏洩対策を講じることができる。
* Microsoft Defender XDR ポータルでのインシデント管理、高度な追求 (Advanced Hunting) の基本を理解する。

---

## 3.1 Microsoft Defender XDR の概要とセキュリティレポート

### Microsoft Defender XDR とは？

* **定義**: Microsoft Defender XDR (Extended Detection and Response) は、エンドポイント、ID、メール、アプリケーションといった複数のセキュリティドメインからのシグナルを統合し、相関分析することで、高度なサイバー攻撃を自動的に検出し、調査し、対応する統合セキュリティプラットフォームです。
* **XDR のコンセプト**: 個別のセキュリティ製品 (EDR, SEG, CASBなど) がサイロ化してアラートを出すのではなく、それらの情報を横断的に分析し、攻撃の全体像 (キルチェーン) を明らかにすることで、より迅速かつ効果的な対応を可能にします。
* **主要コンポーネント (MS-102試験範囲における主要な柱)**:
    * **Microsoft Defender for Endpoint**: エンドポイント (PC, サーバー, モバイル) の保護、検知、対応。
    * **Microsoft Defender for Office 365**: メールとコラボレーションツール (Teams, SharePoint, OneDrive) の保護。
    * **Microsoft Defender for Identity**: オンプレミスの Active Directory 環境におけるIDベースの脅威 (パスザハッシュ攻撃など) の検出 (Entra ID Protectionと連携)。
    * **Microsoft Defender for Cloud Apps**: クラウドアプリケーション (SaaS) の可視化と制御、シャドーIT対策。
    * `[図：Microsoft Defender XDR の主要コンポーネントとシグナルの流れを示すアーキテクチャ図]`
* **統合ポータル**: Microsoft Defender ポータル (`security.microsoft.com`) で、これらのコンポーネントからのアラート、インシデント、レポートを一元的に管理・操作できます。

### Microsoft Defender ポータル (`security.microsoft.com`) の概要

* **ダッシュボード**: 主要なセキュリティ情報（アクティブなインシデント、リスクのあるデバイス/ユーザー、Secure Scoreなど）の概要を表示。
* **インシデントとアラート**:
    * **アラート**: 個々のセキュリティ製品が検出した単一の不審なアクティビティ。
    * **インシデント**: 関連する複数のアラートを自動的にグループ化し、1つの攻撃ストーリーとしてまとめたもの。調査・対応の単位となります。
* **ハンティング (Advanced Hunting)**: Kusto Query Language (KQL) を使用して、過去30日間の生データ (イベントログ) を横断的に検索し、プロアクティブな脅威ハンティングを行う機能。
* **アクションセンター**: 保留中および完了した修復アクションの履歴を確認・管理。
* **脅威分析**: Microsoft のセキュリティリサーチャーが分析した最新の脅威に関する詳細情報と、自組織への影響評価。
* **セキュアスコア**: 組織のセキュリティ体制を評価し、改善のための推奨アクションを提示。
* **学習ハブ**: Defender製品に関する学習コンテンツ。
* **レポート**: セキュリティに関する様々なレポート（脅威保護の状態、脆弱性のあるデバイスなど）。
* **ポリシーとルール**: 各Defender製品のセキュリティポリシー（フィッシング対策、マルウェア対策、ASRルールなど）を一元的に（または各製品の専用セクションで）構成。
    * `[スクリーンショット：Microsoft Defender ポータルのメインダッシュボード]`

### Microsoft Secure Score

* **目的**: Microsoft 365 および Azure 環境における組織の現在のセキュリティ体制を数値化し、改善のための具体的な推奨アクションを提示することで、セキュリティレベルの向上を支援します。
* **スコアの計算**:
    * 組織が実装しているセキュリティコントロールや設定に基づいてスコアが計算されます。
    * Microsoft が推奨するセキュリティベストプラクティスと比較されます。
    * スコアは、ID、データ、デバイス、アプリ、インフラといったカテゴリに分類されます。
* **改善アクション (Improvement Actions)**:
    * スコアを向上させるために実行できる具体的なタスクが表示されます。
    * 各アクションには、達成可能なポイント、実装の難易度、ユーザーへの影響度、前提条件などが記載されています。
    * **例**: 「すべてのユーザーに対してMFAを有効にする」「エンドポイントの攻撃面の縮小ルールを構成する」「DLPポリシーを作成する」など。
* **活用方法**:
    1.  定期的にSecure Scoreを確認し、現在のセキュリティ体制を把握します。
    2.  改善アクションのリストを確認し、ポイントが高く、実装が比較的容易で、かつ組織にとって重要なものから優先順位を付けて取り組みます。
    3.  アクションを実装したら、スコアが実際に向上したかを確認します（反映に時間がかかる場合があります）。
    4.  業界平均や同様の規模の組織との比較も参考にできます。
    5.  `[スクリーンショット：Microsoft Secure Score ダッシュボードと改善アクションリスト]`
* **注意点**: スコアを100%にすることが最終目的ではなく、組織のリスク許容度やビジネス要件に応じて、バランスの取れたセキュリティ対策を実施することが重要です。

### セキュリティレポートとダッシュボードの確認

* **Microsoft Defender ポータル内のレポートセクション**:
    * `[レポート]` > `[全般]` > `[セキュリティレポート]` など。
    * **脅威保護の状態**: マルウェアの検出状況、フィッシングメールの傾向、悪意のあるURLのクリック状況など。
    * **脆弱なデバイス**: Defender for Endpointが検出した脆弱性を持つデバイスの一覧や、OSバージョンごとの分布など。
    * **メールフローの状態**: Exchange Online Protection (EOP) や Defender for Office 365 によるメールフィルタリングの統計。
    * `[スクリーンショット：代表的なセキュリティレポートの例（脅威保護レポートなど）]`
* **レポートの活用**:
    * セキュリティ対策の効果を測定します。
    * 潜在的なリスクや攻撃のトレンドを特定します。
    * 経営層や関係者への報告資料として利用します。
    * コンプライアンス監査の証跡として役立てます。

### ハンズオン演習アイデア

* **演習3.1: Microsoft Defender ポータルの探索**
    1.  `security.microsoft.com` にアクセスし、グローバル管理者またはセキュリティ管理者ロールでサインインする。
    2.  ダッシュボードの各ウィジェット（インシデント、アクティブな脅威、Secure Scoreなど）を確認する。
    3.  左側のナビゲーションメニューから、インシデント、アラート、ハンティング、アクションセンター、脅威分析などの主要なセクションを実際に開いてみて、どのような情報が表示されるかを確認する。
* **演習3.2: Microsoft Secure Scoreの確認と改善アクションの検討**
    1.  Microsoft Secure Score ダッシュボードを開く。
    2.  自テナントの現在のスコアと、カテゴリ別のスコアを確認する。
    3.  「改善アクション」タブで、推奨されているアクションをいくつか見てみる。
    4.  ポイントが高く、実装ステータスが「未完了」または「計画済み」のアクションを1つ選び、その詳細（説明、前提条件、ユーザーへの影響など）を確認する。もしこのアクションを自分の組織で実装するとしたら、どのような手順と考慮が必要かを考察する。
* **演習3.3: セキュリティレポートの確認**
    1.  Microsoft Defender ポータルのレポートセクションで、「脅威保護の状態」レポートや「メールフローの状態」レポートなどを開いてみる（データが少ない場合もある）。
    2.  どのような情報（グラフ、表）が表示され、そこから何が読み取れるかを考察する。

---

## 3.2 Defender for Office 365 によるメールとコラボレーションの保護

### Microsoft Defender for Office 365 (MDO) の概要

* **目的**: Exchange Online Protection (EOP) の基本的な保護機能に加え、フィッシング、マルウェア、ビジネスメール詐欺 (BEC)、資格情報窃取などの高度な脅威から、メール（Exchange Online）およびコラボレーションツール（SharePoint Online, OneDrive for Business, Microsoft Teams）を保護します。
* **プラン**: Plan 1 と Plan 2 があり、Plan 2 はより高度な機能（攻撃シミュレーション、自動調査と対応など）を含みます。MS-102では両プランの主要機能が範囲となります。
* **主要機能**:
    * **安全な添付ファイル (Safe Attachments)**: 未知のマルウェアやゼロデイ攻撃から保護するため、仮想環境（サンドボックス）で添付ファイルを実行・分析します。
    * **安全なリンク (Safe Links)**: メールやTeamsメッセージ内のURLをスキャンし、悪意のあるサイトへのアクセスをブロックします。クリック時にリアルタイムで検査します。
    * **フィッシング対策ポリシー (Anti-phishing)**: なりすまし（ユーザー偽装、ドメイン偽装）、スピアフィッシング、ホエーリングなどの高度なフィッシング攻撃を検出・ブロックします。メールボックスインテリジェンスを活用します。
    * **迷惑メール対策 (Anti-spam)** と **マルウェア対策 (Anti-malware)**: EOPの機能を強化し、より高度なフィルタリングを提供します。
    * **リアルタイム検出 (Real-time detections)**: 脅威ハンティングやレポートに使用される詳細な検出情報。
    * **脅威エクスプローラー (Threat Explorer) / リアルタイム検出**: (Plan 2) メールやファイル、URLに関する脅威情報を詳細に調査し、手動で修復アクションを実行できます。
    * **攻撃シミュレーショントレーニング (Attack Simulation Training)**: (Plan 2) ユーザーのセキュリティ意識向上のため、模擬フィッシング攻撃を実施し、トレーニングを提供します。
    * **自動調査と対応 (AIR - Automated Investigation and Response)**: (Plan 2) 特定の脅威アラートに対して、自動的に調査プレイブックを実行し、修復アクションを提案または実行します。
    * `[図：Defender for Office 365 の主要機能と保護対象の関係図]`

### 安全な添付ファイル (Safe Attachments) ポリシーの構成

* **目的**: メールやSharePoint/OneDrive/Teams内のファイルに含まれる悪意のある添付ファイルを開く前に検出し、ユーザーを保護します。
* **動作の仕組み**:
    1.  メール受信時またはファイルアップロード時に、MDOが添付ファイルをスキャンします。
    2.  シグネチャベースで既知のマルウェアを検出します。
    3.  未知のファイルや疑わしいファイルは、仮想環境（サンドボックス、デトネーションチャンバーとも呼ばれる）に送信され、そこで実際にファイルを開いて動作を分析します（ビヘイビア分析）。
    4.  悪意のある動作が検出された場合、ファイルはブロックされるか、安全なバージョンに置き換えられます。
* **ポリシー設定項目**:
    * **対象**: ポリシーを適用する受信者（ユーザー、グループ、ドメイン）。
    * **アクション (マルウェアが検出された場合の動作)**:
        * **ブロック**: メール全体をブロックし、配信しません。
        * **置換**: 添付ファイルを削除し、マルウェアが検出されたことを示すテキストファイルに置き換えます。
        * **動的配信 (Dynamic Delivery)**: メールの本文は先に配信し、添付ファイルはスキャンが完了するまでプレースホルダーとして表示します。スキャン完了後に安全であれば添付ファイルが利用可能になります（ユーザー体験とセキュリティのバランス）。
    * **リダイレクト**: 検出された添付ファイルを含むメッセージを、分析のために特定のメールアドレス（例: セキュリティチーム）にリダイレクトします。
    * **SharePoint, OneDrive, Microsoft Teams の保護**: これらのサービス内のファイルに対しても安全な添付ファイル機能を有効化できます。
* **構成手順 (Microsoft Defender ポータル)**:
    1.  `[メールとコラボレーション]` > `[ポリシーとルール]` > `[脅威対策ポリシー]` > `[安全な添付ファイル]`。
    2.  `[+ 作成]` をクリックして新しいポリシーを作成するか、既存の既定ポリシーを編集します。
    3.  ポリシー名、対象の受信者ドメインまたはユーザー/グループを指定します。
    4.  保護設定（マルウェア検出時のアクション、リダイレクトなど）を構成します。
        * `[スクリーンショット：安全な添付ファイルポリシーの設定画面 - アクション選択]`
    5.  ポリシーの優先度を設定し、有効化します。
* **つまずきやすいポイント**: 動的配信を選択した場合のユーザーエクスペリエンスの周知。スキャンに時間がかかるファイルがある場合の対処。

### 安全なリンク (Safe Links) ポリシーの構成

* **目的**: メール、Teamsメッセージ、Officeドキュメント内のURLをクリックした際に、悪意のあるWebサイト（フィッシングサイト、マルウェア配布サイト）へのアクセスをブロックし、ユーザーを保護します。
* **動作の仕組み**:
    1.  MDOは、メッセージ内のURLをMicrosoftの安全なURL（例: `https://nam01.safelinks.protection.outlook.com/...`）に書き換えます。
    2.  ユーザーがこの書き換えられたURLをクリックすると、まずMDOのサーバーにリダイレクトされます。
    3.  MDOサーバーは、元のURLをリアルタイムでスキャンし、既知の悪意のあるサイトのリストやその他の脅威インテリジェンスと照合します。
    4.  安全と判断されれば元のURLにリダイレクトされます。悪意があると判断されれば、ブロックページが表示されるか、警告が表示されます。
* **ポリシー設定項目**:
    * **対象**: ポリシーを適用する受信者（ユーザー、グループ、ドメイン）。
    * **URLおよびファイルに対するアクション**:
        * **オン**: 安全なリンク保護を有効にします。
        * **クリック時の保護**: ユーザーがリンクをクリックしたときにリアルタイムでスキャンします（推奨）。
        * **悪意のあるとわかっているリンクをブロックする**: はい/いいえ。
    * **Office 365 ProPlus, Office for iOS and Android 内のリンクに対する保護**: これらのアプリ内のリンクにも保護を適用します。
    * **"次のURLを書き換えない" リスト (Do not rewrite the following URLs)**: 特定の信頼できる内部URLなどを書き換え対象から除外します。
    * **ユーザーのクリックを追跡する**: 管理者がレポートでクリック状況を確認できるようにします。
* **構成手順 (Microsoft Defender ポータル)**:
    1.  `[メールとコラボレーション]` > `[ポリシーとルール]` > `[脅威対策ポリシー]` > `[安全なリンク]`。
    2.  `[+ 作成]` または既存ポリシー編集。
    3.  ポリシー名、対象の受信者ドメインまたはユーザー/グループを指定。
    4.  保護設定（クリック時スキャン、Officeアプリ内保護、書き換えないURLリストなど）を構成します。
        * `[スクリーンショット：安全なリンクポリシーの設定画面 - URL保護設定]`
    5.  通知設定（ユーザーへの警告メッセージなど）。
    6.  ポリシーの優先度を設定し、有効化します。
* **つまずきやすいポイント**: URL書き換えによる見た目の変化に対するユーザーへの周知。「書き換えないURLリスト」の適切な管理。

### フィッシング対策ポリシー (Anti-phishing) の構成

* **目的**: 一般的なフィッシング攻撃に加え、特定の個人や組織を狙った巧妙なスピアフィッシング、CEO詐欺（ビジネスメール詐欺, BEC）、なりすまし攻撃から保護します。
* **主要機能**:
    * **なりすまし保護 (Spoof intelligence)**:
        * **ユーザー偽装 (User impersonation)**: 組織内の重要なユーザー（役員など）や外部の特定のメールアドレスになりすましたメールを検出します。保護するユーザーとアクション（隔離、迷惑メールへ移動など）を指定します。
        * **ドメイン偽装 (Domain impersonation)**: 組織の所有ドメインや、指定した外部ドメイン（パートナー企業など）になりすましたメールを検出します。
        * **メールボックスインテリジェンス (Mailbox intelligence)**: 各ユーザーの通常の通信パターンを学習し、それに基づいて不審なメール（普段やり取りしない送信者からの緊急の依頼など）を識別しやすくします。
    * **高度なフィッシングしきい値**: フィッシング判定の感度（標準、積極的、より積極的、最も積極的）を設定します。
    * **安全性のヒントとインジケーター**: Outlookクライアントに、不審なメールであることを示すヒント（例:「この送信者は正しく認証されていません」）を表示します。
* **構成手順 (Microsoft Defender ポータル)**:
    1.  `[メールとコラボレーション]` > `[ポリシーとルール]` > `[脅威対策ポリシー]` > `[フィッシング対策]`。
    2.  `[+ 作成]` または既存ポリシー編集。
    3.  ポリシー名、対象の受信者ドメインまたはユーザー/グループを指定。
    4.  フィッシングしきい値と偽装設定:
        * **保護するユーザー**: 偽装から保護したいユーザー（役員など）を指定。
        * **保護するドメイン**: 偽装から保護したい自社ドメインや信頼できる外部ドメインを指定。
        * **偽装メールに対するアクション**: 隔離、迷惑メールへ移動、リダイレクトなど。
        * **メールボックスインテリジェンスの有効化**。
        * `[スクリーンショット：フィッシング対策ポリシーの偽装設定画面]`
    5.  安全性のヒントの有効化。
    6.  ポリシーの優先度を設定し、有効化します。
* **つまずきやすいポイント**: 保護するユーザーやドメインのリストを適切に維持管理すること。メールボックスインテリジェンスが効果を発揮するにはある程度の学習期間が必要。

### 脅威エクスプローラー (Threat Explorer) / リアルタイム検出 (Plan 2 機能)

* **目的**: セキュリティアナリストや管理者が、メール、ファイル、URL、ユーザーアクティビティに関する脅威情報をプロアクティブに検索、調査し、必要に応じて手動で修復アクションを実行するための強力なツールです。
* **主な機能**:
    * **検索とフィルタリング**: 送信者、受信者、件名、IPアドレス、URL、マルウェアファミリー、配信アクション（配信済み、ブロック、隔離など）といった多様な条件でデータを検索。
    * **メールのタイムライン表示**: 特定のメールが組織内でどのように処理されたか（フィルタリング、ユーザー操作など）を時系列で表示。
    * **URLクリックデータの分析**: どのユーザーがどの悪意のあるURLをクリックしたか。
    * **マルウェアファミリーの特定と影響範囲調査**。
    * **手動アクション**:
        * メールの移動（受信トレイから迷惑メールへ、迷惑メールから受信トレイへ、削除）。
        * メールの完全削除 (Soft delete / Hard delete)。
        * ファイルのブロック。
        * 自動調査の開始。
    * `[スクリーンショット：脅威エクスプローラーの検索インターフェースと結果表示例]`
* **活用シナリオ**:
    * 特定のフィッシングキャンペーンの影響範囲調査。
    * 誤検知されたメールの救済。
    * 侵害されたアカウントからのメール送信の追跡と対処。

### 攻撃シミュレーショントレーニング (Plan 2 機能)

* **目的**: 組織内のユーザーのフィッシング攻撃に対する耐性を評価し、継続的なトレーニングを通じてセキュリティ意識を向上させます。
* **主なステップ**:
    1.  **シミュレーションの作成**:
        * **攻撃手法の選択**: 資格情報ハーベスティング、マルウェア添付ファイル、リンクイン添付ファイル、ドライブバイURLなど。
        * **ペイロードの選択**: Microsoftが提供するテンプレートや、カスタムペイロードを使用。
        * **対象ユーザーの選択**: 全員または特定のグループ。
        * **スケジュールの設定**: 開始日、終了日。
    2.  **トレーニングの割り当て**: シミュレーションで「失敗」したユーザー（例: フィッシングリンクをクリックした）に対して、自動的に関連するトレーニングモジュールを割り当てる。
    3.  **結果の分析**:
        * クリック率、資格情報を提供したユーザーの割合。
        * 部門別、ユーザー別のレポート。
        * 時間の経過とともに改善が見られるか追跡。
    * `[スクリーンショット：攻撃シミュレーショントレーニングの作成ウィザードと結果レポート例]`
* **効果的な運用**:
    * 定期的に（例: 四半期ごと）異なるシナリオで実施する。
    * 結果を匿名化して組織全体で共有し、意識向上を促す。
    * ポジティブなフィードバックと継続的な教育を重視する。

### ハンズオン演習アイデア

* **演習3.4: 安全な添付ファイルポリシーの作成**
    1.  テストユーザーグループを対象とした安全な添付ファイルポリシーを作成する。
    2.  マルウェア検出時のアクションを「動的配信」に設定する。
    3.  （可能であれば）EICARテストファイルなどの無害なテスト用マルウェアファイルを添付したメールをテストユーザーに送信し、動的配信の動作（メール本文が先に届き、添付ファイルスキャン後に利用可能になる）を確認する。
* **演習3.5: 安全なリンクポリシーの作成**
    1.  テストユーザーグループを対象とした安全なリンクポリシーを作成する。
    2.  「クリック時の保護」を有効にし、Officeアプリ内での保護も有効にする。
    3.  テストユーザーに、既知の安全なURLと、テスト用の（悪意はないがMDOでブロックされる可能性のある）URLを含むメールを送信する。
    4.  書き換えられたURLの形式と、クリック時の動作（ブロックページや警告など）を確認する。
* **演習3.6: フィッシング対策ポリシーの構成 (偽装保護)**
    1.  テストユーザーグループを対象としたフィッシング対策ポリシーを作成する。
    2.  「保護するユーザー」として、テナント内の別のテスト管理者アカウントを指定する。
    3.  「保護するドメイン」として、自テナントのカスタムドメインを指定する。
    4.  偽装メールに対するアクションを「メッセージを検疫する」に設定する。
    5.  （シミュレーション）外部から、保護対象ユーザーになりすましたメール（送信者表示名が同じだがメールアドレスは異なるなど）をテストユーザーに送信し、検疫されるか確認する。
* **演習3.7: 脅威エクスプローラーの利用 (Plan 2環境があれば)**
    1.  脅威エクスプローラー（またはリアルタイム検出）を開く。
    2.  過去24時間以内に配信されたメールで、特定のキーワード（例: 「請求書」）を件名に含むものを検索してみる。
    3.  特定のメールを選択し、その配信場所、検出技術、関連イベントなどを確認する。

---

## 3.3 Defender for Endpoint によるエンドポイント保護

### Microsoft Defender for Endpoint (MDE) の概要

* **目的**: エンタープライズのエンドポイント（Windows, macOS, Linux, iOS, Android）に対する、予防的な保護、侵害後の検出、自動調査、および対応を提供する包括的なセキュリティプラットフォームです。
* **主要機能 (5つの柱)**:
    1.  **脅威と脆弱性の管理 (Threat & Vulnerability Management)**: リアルタイムで脆弱性を発見、評価し、優先順位付けを行い、修復を支援します。
    2.  **攻撃面の縮小 (Attack Surface Reduction - ASR)**: 設定ミスや悪用されやすい攻撃経路を最小限に抑えます（ASRルール、ネットワーク保護、Web保護、デバイス制御など）。
    3.  **次世代保護 (Next-generation Protection)**: クラウドベースの機械学習、ビヘイビア分析、シグネチャベースの保護を組み合わせ、既知および未知のマルウェアをブロックします (Microsoft Defender ウイルス対策が中核)。
    4.  **エンドポイントでの検出と対応 (Endpoint Detection and Response - EDR)**: 高度な攻撃や侵害の兆候を検出し、アラートを生成し、調査のための詳細なテレメトリを提供します。
    5.  **自動調査と修復 (Automated Investigation and Response - AIR)**: アラートに基づいて自動的に調査を実行し、脅威を修復または管理者に修復を推奨します。
    * `[図：Defender for Endpoint の5つの主要機能とそれらの連携を示す図]`
* **プラン**: Plan 1 (基本的なウイルス対策、ASRなど) と Plan 2 (Plan 1 + EDR, 脆弱性管理, AIRなどフル機能) があります。MS-102ではPlan 2の機能が中心となります。
* **オンボーディング**: 保護対象のデバイスをMDEサービスに登録（オンボーディング）する必要があります。オンボーディング方法はOSや管理ツール（Intune, Configuration Manager, GPO, ローカルスクリプトなど）によって異なります。

### デバイスのオンボーディング

* **サポートされるOS**: Windows (クライアント/サーバー), macOS, Linux, iOS, Android。
* **オンボーディング方法の選択**:
    * **Microsoft Intune (推奨)**: クラウドベースの統合エンドポイント管理。ポリシー展開とオンボーディングが容易。
    * **Microsoft Configuration Manager**: 既存のオンプレミス管理インフラを活用。共同管理シナリオも可能。
    * **グループポリシー (GPO)**: ドメイン参加済みWindowsデバイス向け。
    * **ローカルスクリプト**: スタンドアロンデバイスや小規模展開向け。
    * **VDI環境向け**: 非永続的VDIセッションのオンボーディング。
* **オンボーディングパッケージの取得**: Microsoft Defender ポータル > `[設定]` > `[エンドポイント]` > `[オンボーディング]` から、OSと展開方法に応じたパッケージ（スクリプトや構成ファイル）をダウンロードします。
    * `[スクリーンショット：MDEオンボーディングパッケージのダウンロード画面]`
* **接続の確認**: オンボーディング後、デバイスがDefenderポータルのデバイスインベントリに表示され、センサーが正常にデータを送信しているかを確認します。
    * 検出テスト: EICARテストファイルをダウンロードするなどして、基本的なマルウェア検出とアラート生成を確認します。

### 脅威と脆弱性の管理 (TVM)

* **目的**: 組織内のエンドポイントにおけるソフトウェアの脆弱性や設定ミスを継続的に検出し、リスクに基づいて優先順位を付け、修復プロセスを効率化します。
* **主な機能**:
    * **デバイスインベントリ**: ソフトウェア、ハードウェア、OSバージョンなどの情報を収集。
    * **ソフトウェアの脆弱性検出**: Common Vulnerabilities and Exposures (CVE) に基づく脆弱性情報を表示。
    * **構成の誤り (Security baselines assessment)**: Microsoft推奨のセキュリティベースラインからの逸脱を検出。
    * **公開スコア (Exposure Score)**: 組織全体の脆弱性リスクを数値化。
    * **セキュリティ推奨事項**: 脆弱性や設定ミスを修正するための具体的な推奨アクション（パッチ適用、設定変更など）を提示。優先度（影響度、悪用可能性など）も表示。
    * **修復要求の作成と追跡**: IntuneやConfiguration Managerと連携し、パッチ適用などの修復タスクを作成・追跡できます。
    * `[スクリーンショット：TVMダッシュボード - 公開スコアと上位のセキュリティ推奨事項]`
* **活用フロー**:
    1.  TVMダッシュボードで公開スコアと上位の推奨事項を確認。
    2.  特定の脆弱性や設定ミスについて詳細を調査（影響を受けるデバイス、関連するCVEなど）。
    3.  推奨される修復方法を実施（手動またはITSMツール連携）。
    4.  修復後、スコアが改善されるか確認。

### 攻撃面の縮小 (ASR)

* **目的**: マルウェアがよく利用する攻撃経路や、リスクの高いソフトウェアの動作をブロックまたは監査することで、攻撃対象領域を減らします。
* **主要なASR機能**:
    * **攻撃面の縮小ルール (ASR Rules)**:
        * Officeアプリからの子プロセス作成のブロック、Adobe Readerからの子プロセス作成のブロック、LSASSからの資格情報窃取のブロック、WMIイベントサブスクリプションを通じた永続化のブロックなど、約15種類の定義済みルール。
        * 各ルールは、ブロックモード、監査モード、警告モード、無効のいずれかで構成可能。
        * **監査モード**: ブロックはしないが、ルールがトリガーされた場合にイベントをログに記録。本番適用前の影響評価に不可欠。
        * **除外設定**: 特定のファイルやフォルダー、プロセスをASRルールの対象外とすることができます（誤検知対応）。
        * **構成方法**: Intune, Configuration Manager, GPO, PowerShell。
        * `[スクリーンショット：IntuneでのASRルール構成プロファイル例]`
    * **ネットワーク保護 (Network Protection)**:
        * デバイスがインターネット上の悪意のあるドメインやIPアドレス（フィッシングサイト、マルウェア配布元など）にアクセスするのをブロックします。
        * Webブラウザーだけでなく、任意のプロセスからのアウトバウンド接続に適用されます。
        * ブロックモードまたは監査モードで構成可能。
    * **Web保護 (Web Protection)**:
        * ネットワーク保護を補完し、Webコンテンツフィルタリング（カテゴリベースのサイトブロック）、カスタムインジケーター（特定のURL/IPのブロック/許可）を提供します。
    * **デバイス制御 (Device Control)**:
        * USBストレージ、Bluetoothデバイスなどのリムーバブルメディアの使用を制御（読み取り専用、書き込み禁止、完全ブロックなど）。
        * 特定のデバイス（シリアル番号指定など）のみ許可することも可能。
    * **アプリケーション制御 (Application Control)**: (Windows Defender Application Control - WDAC)
        * 許可されたアプリケーションのみを実行できるようにするホワイトリスト方式の制御。非常に強力ですが、運用管理が複雑になる場合があります。
    * **ランサムウェア対策 (Controlled Folder Access)**:
        * 指定した保護フォルダー（ドキュメント、ピクチャなど）への不正な変更（ランサムウェアによる暗号化など）を監視し、信頼されていないアプリからのアクセスをブロックします。

### 次世代保護 (Microsoft Defender ウイルス対策)

* **目的**: 既知および未知のマルウェア（ウイルス、ワーム、トロイの木馬、スパイウェア、ランサムウェアなど）からエンドポイントを保護します。
* **主要機能**:
    * **リアルタイム保護**: ファイルのアクセス時や実行時に常時スキャン。
    * **クラウド提供の保護 (Cloud-delivered protection)**: Microsoftのクラウドベースの脅威インテリジェンスと機械学習モデルを活用し、新しい脅威に迅速に対応します。
    * **挙動監視 (Behavioral monitoring)**: プロセスの不審な動作を検出し、マルウェアの兆候を捉えます。
    * **定義ファイルの更新**: 定期的に最新のマルウェア定義ファイル（シグネチャ）をダウンロード。
    * **スケジュールスキャン**: 定期的にフルスキャンやクイックスキャンを実行。
    * **PUA (Potentially Unwanted Application) 保護**: アドウェアやバンドルソフトなど、マルウェアではないが望ましくない可能性のあるアプリケーションをブロックまたは監査します。
    * **改ざん防止 (Tamper Protection)**: 悪意のあるソフトウェアや不正なユーザーがMicrosoft Defender ウイルス対策のセキュリティ設定を無効にしたり変更したりするのを防ぎます。
* **構成方法**: Intune, Configuration Manager, GPO, PowerShell, Microsoft Defender ポータル（一部設定）。

### エンドポイントでの検出と対応 (EDR)

* **目的**: 攻撃者が防御を回避してエンドポイントに侵入した場合に、その活動を迅速に検出し、調査し、封じ込めるための機能です。
* **仕組み**:
    * エンドポイントセンサーが、OSカーネルレベルで詳細なアクティビティデータ（プロセス作成、ネットワーク接続、レジストリ変更、ファイル操作など）を収集し、MDEクラウドサービスに送信します。
    * クラウドサービス側で、これらのテレメトリを分析し、機械学習、行動分析、脅威インテリジェンスを駆使して、不審なアクティビティや攻撃の兆候を検出します。
* **アラートとインシデント**:
    * 検出された脅威はアラートとしてMicrosoft Defender ポータルに表示されます。
    * 関連するアラートは自動的にインシデントに集約され、攻撃の全体像が把握しやすくなります。
    * アラートには、MITRE ATT&CKフレームワークに基づいた攻撃手法や関連情報が含まれます。
* **調査機能**:
    * **デバイスのタイムライン**: 特定のデバイスで発生したイベント（プロセス、ネットワーク、ファイルなど）を時系列で詳細に表示。攻撃の痕跡を追跡できます。
        * `[スクリーンショット：MDEのデバイスタイムライン表示例]`
    * **ファイルの詳細ページ**: ファイルのハッシュ値、普及率、関連するプロセスなどを表示。
    * **IPアドレス/ドメインの詳細ページ**: 関連する脅威情報や通信履歴を表示。
    * **高度な追求 (Advanced Hunting)**: KQLを使用して、EDRデータを横断的に検索し、カスタムの検出ルールを作成できます。
* **対応アクション**:
    * **デバイスの分離 (Isolate device)**: デバイスをネットワークから隔離し、脅威の横展開を防ぎます（MDEサービスとの通信は維持）。
    * **ライブレスポンス (Live Response)**: セキュリティオペレーターがリモートデバイスにセキュアなコマンドラインセッションを確立し、フォレンジック調査（ファイル収集、プロセス確認など）や手動での修復アクション（プロセス終了、ファイル削除など）を実行できます。
    * **インジケーターの追加**: 特定のファイルハッシュ、IPアドレス、URL、証明書を「ブロック」または「許可」するカスタムインジケーターを作成し、組織全体のエンドポイントに適用できます。
    * **マルウェア対策スキャンの実行**: デバイス上でフルスキャンやクイックスキャンをリモートで開始。
    * **調査パッケージの収集**: デバイスから詳細なログや構成情報を収集。

### 自動調査と修復 (AIR)

* **目的**: セキュリティアラートのトリアージと修復にかかる時間と労力を削減するため、一般的な調査と修復のプロセスを自動化します。
* **仕組み**:
    * アラートがトリガーされると、AIRは自動的に調査プレイブックを実行します。
    * 関連するエンティティ（ファイル、プロセス、サービス、ドライバーなど）を分析し、悪意があるかどうかを判断します。
    * 調査結果に基づいて、修復アクション（ファイルの隔離、プロセスの停止、レジストリキーの削除など）を提案または自動的に実行します。
* **自動化レベル**:
    * **半自動 (Semi-automated)**: 調査は自動で行われるが、修復アクションの実行には管理者の承認が必要。
    * **全自動 (Fully automated)**: 調査と修復の両方が自動的に行われる（特定の信頼度レベルに達した場合）。
    * デバイスグループごとに自動化レベルを設定できます。
* **アクションセンター**: AIRが実行した調査や修復アクションの履歴、保留中のアクションなどを確認できます。

### ハンズオン演習アイデア

* **演習3.8: MDEへのデバイスオンボーディング (ローカルスクリプト)**
    1.  (テスト用Windowsデバイスを用意) Microsoft Defender ポータルから、ローカルスクリプト方式のオンボーディングパッケージをダウンロードする。
    2.  テストデバイスでスクリプトを実行し、デバイスがMDEにオンボーディングされることを確認する（Defenderポータルのデバイスインベントリに表示されるまで時間がかかる場合あり）。
    3.  EICARテストファイルをダウンロードし、Microsoft Defender ウイルス対策が検出し、MDEポータルにアラートが上がることを確認する。
* **演習3.9: 脅威と脆弱性の管理の確認**
    1.  オンボーディングしたテストデバイスがTVMに表示され、ソフトウェアインベントリや検出された脆弱性（もしあれば）が確認できるかを見てみる。
    2.  セキュリティ推奨事項の例を確認する。
* **演習3.10: ASRルールの構成とテスト (監査モード)**
    1.  (Intune環境があればIntuneで、なければローカルポリシーエディタやPowerShellで) テストデバイスに対して、いずれかのASRルール（例: 「Office アプリケーションによる子プロセスの作成をブロックする」）を「監査モード」で有効にする。
    2.  ルールがトリガーされるような操作（例: Wordからcmd.exeを起動しようとするマクロ）を実行し、イベントログやDefenderポータルのレポートで監査イベントが記録されることを確認する。
* **演習3.11: EDRアラートの確認とデバイスタイムラインの調査**
    1.  演習3.8でEICARテストファイルによって生成されたアラートをDefenderポータルで確認する。
    2.  アラートに関連付けられたデバイスをクリックし、デバイスのタイムラインを開いて、マルウェア検出に関連するプロセスやファイルアクセスなどのイベントが表示されるか確認する。
* **演習3.12: ライブレスポンスセッションの開始 (概念理解・デモ)**
    * (実際の操作は慎重に) ライブレスポンスセッションを開始する手順と、利用可能なコマンド（`dir`, `ps`, `fileinfo`, `getfile`など）を確認する。
    * どのような調査や対応が可能になるかを理解する。

---

## 3.4 Defender for Cloud Apps によるクラウドアプリの保護

### Microsoft Defender for Cloud Apps (MDCA) の概要

* **目的**: 組織で使用されているクラウドアプリケーション（SaaSアプリ）に対する可視性の向上、データ制御、脅威保護、コンプライアンス対応を提供するCASB (Cloud Access Security Broker) ソリューションです。
* **主な機能**:
    * **シャドーITの検出と管理 (Cloud Discovery)**: ファイアウォールやプロキシのログを分析し、組織内で従業員が利用しているクラウドアプリ（承認済み/未承認）を特定し、リスク評価を行います。
    * **承認済みアプリの保護 (App Connectors)**: 主要なSaaSアプリ（Microsoft 365, Salesforce, Box, Dropbox, Google Workspaceなど）とAPI連携し、アクティビティログの収集、ファイルスキャン、ポリシー適用を行います。
    * **情報保護とDLP**: クラウドアプリ内の機密情報を検出し、秘密度ラベルの適用やDLPポリシーによる制御を行います (Microsoft Purviewと連携)。
    * **脅威検出**: クラウドアプリにおける異常なアクティビティ（不審なサインイン、大量ダウンロード、権限昇格など）を検出し、アラートを生成します。
    * **条件付きアクセスアプリ制御 (Conditional Access App Control)**: Microsoft Entra 条件付きアクセスと連携し、クラウドアプリへのアクセスやセッション中のアクティビティ（ダウンロードブロック、アクティビティ監視など）をリアルタイムで制御します (リバースプロキシベース)。
    * **アプリガバナンス**: OAuthアプリの監査と管理、アプリの権限やアクティビティの監視。
    * `[図：Defender for Cloud Apps の主要機能と動作イメージ（Cloud Discovery, App Connector, Conditional Access App Control）]`

### Cloud Discovery によるシャドーITの検出

* **シャドーITとは**: IT部門が把握・管理していない、従業員が業務で利用しているクラウドサービスやアプリのこと。セキュリティリスクやコンプライアンス違反の原因となる可能性があります。
* **検出方法**:
    1.  **ログコレクターの展開**: オンプレミスのファイアウォールやプロキシサーバーからログを収集するためのログコレクターをVMなどに展開します（手動アップロードも可能）。
    2.  **ログのアップロードと分析**: 収集したトラフィックログをMDCAにアップロードすると、MDCAがログを分析し、利用されているクラウドアプリを特定します。
    3.  **Cloud Discoveryダッシュボード**: 検出されたアプリの一覧、各アプリのリスクスコア（10段階）、トラフィック量、ユーザー数などを表示します。
        * `[スクリーンショット：Cloud Discovery ダッシュボードのアプリカタログとリスク評価]`
* **アプリの評価と管理**:
    * **リスクスコア**: 各アプリのセキュリティ、コンプライアンス、法務に関する80以上の要因に基づいて評価されます。
    * **アプリの承認/未承認**: 検出されたアプリを「承認済み (Sanctioned)」または「未承認 (Unsanctioned)」としてタグ付けできます。
    * 未承認アプリへのアクセスをブロックするために、ファイアウォールやプロキシに連携するスクリプトを生成できます。

### アプリコネクタを使用した承認済みアプリの保護

* **目的**: 組織が正式に利用しているSaaSアプリケーションに対して、より深い可視性と制御を提供します。
* **仕組み**: 各SaaSアプリの提供するAPIを利用してMDCAと連携し、以下の情報を収集・制御します。
    * **アクティビティログ**: ユーザーのサインイン、ファイル操作、設定変更などのアクティビティ。
    * **ファイル**: 保存されているファイルの内容をスキャンし、機密情報やマルウェアを検出。
    * **ユーザーアカウント**: アプリ内のユーザー情報。
* **接続可能なアプリの例**: Microsoft 365, Salesforce, ServiceNow, Box, Dropbox, Google Workspace, GitHubなど多数。
* **接続手順 (Microsoft Defender ポータル)**:
    1.  `[設定]` > `[クラウドアプリ]` > `[アプリコネクタ]` を選択。
    2.  `[+ アプリの接続]` をクリックし、接続したいアプリを選択します。
    3.  各アプリのAPI接続に必要な手順（認証情報の提供、権限の付与など）を実行します。
        * `[スクリーンショット：MDCAアプリコネクタの接続ウィザード例]`
* **接続後の活用**:
    * **アクティビティログの調査**: 特定のアプリでのユーザーアクティビティを詳細に追跡。
    * **ファイルポリシーの作成**: 機密情報を含むファイルを検出した場合にアラート、ラベル付け、アクセス制限などのアクションを実行。
    * **脅威検出ポリシーの適用**: 異常なアクティビティ（例: 通常とは異なる場所からの大量ダウンロード）を検出。

### ポリシーによる制御

* **MDCAで作成できるポリシーの種類**:
    * **アクティビティポリシー**: 特定のアクティビティ（例: 管理者権限の変更、異常な量のファイル共有）が発生した場合にアラートを生成したり、アクション（アカウント停止など）を実行したりします。
        * **例**: 「不可能な移動 (Impossible travel)」ポリシー: 短時間に地理的に離れた場所からのアクセスを検出。
    * **ファイルポリシー**: クラウドアプリ内に保存されているファイルをスキャンし、条件（ファイル名、機密情報の種類、アクセスレベルなど）に一致する場合にアクション（ラベル付け、隔離、所有者への通知など）を実行します。
        * **例**: 「公開共有されているファイルにクレジットカード情報が含まれている」場合にアラート。
    * **異常検出ポリシー**: 機械学習に基づいてユーザーの通常の行動パターンから逸脱するアクティビティを自動的に検出し、アラートを生成します（組み込みポリシーが多い）。
    * **OAuthアプリポリシー**: ユーザーが許可したOAuthアプリの権限やアクティビティを監視し、リスクの高いアプリを検出・禁止します。
    * **シャドーITディスカバリーポリシー (Cloud Discoveryポリシー)**: 新しく検出されたアプリや、特定のリスクレベルを超えるアプリが検出された場合にアラートを生成します。
* **ポリシーの構成要素**:
    * **重大度**: ポリシー違反の重要度。
    * **カテゴリ**: ポリシーの種類（脅威検出、情報保護など）。
    * **フィルター**: ポリシーの適用対象となる条件（アプリ、ユーザー、アクティビティタイプ、IPアドレスなど）。
    * **アクション**: ポリシー違反時に実行するアクション（アラート、ユーザーへの通知、ファイルの隔離、アカウントの無効化、Power Automateフローのトリガーなど）。
    * `[スクリーンショット：MDCAのアクティビティポリシー作成画面例]`

### 条件付きアクセスアプリ制御 (Conditional Access App Control)

* **目的**: Microsoft Entra 条件付きアクセスポリシーと連携し、ユーザーがクラウドアプリにアクセスした後、セッション中のリアルタイムな制御を提供します。リバースプロキシとして動作します。
* **仕組み**:
    1.  Entra ID 条件付きアクセスポリシーで、特定の条件下（例: アンマネージドデバイスからのアクセス）でクラウドアプリへのアクセスをMDCA経由（リバースプロキシ経由）にリダイレクトするように設定します。
    2.  MDCAはユーザーセッションを監視し、事前に定義されたセッションポリシーに基づいてリアルタイムでアクションを実行します。
* **可能な制御**:
    * **ダウンロードのブロック/保護**: 機密情報を含むファイルのダウンロードをブロックしたり、ダウンロード時にラベル付けや暗号化を強制したりします。
    * **アップロードのブロック/保護**: 機密情報のアップロードをブロックしたり、アップロード時にスキャンを実行したりします。
    * **切り取り/コピー/貼り付け/印刷のブロック**: 機密データがクリップボード経由で漏洩するのを防ぎます。
    * **アクティビティの監視**: 詳細なセッションアクティビティをログに記録します。
    * **カスタムブロックページ**: ユーザーにブロック理由や代替手段を通知します。
* **構成手順**:
    1.  **Entra ID 条件付きアクセスポリシーの作成**:
        * `[アクセス制御]` > `[セッション]` で `[条件付きアクセスアプリ制御を使用する]` を選択し、ポリシーの種類（監視のみ、ダウンロードのブロックなど）を指定します。
    2.  **MDCA セッションポリシーの作成**:
        * 特定のアプリ、ユーザー、アクティビティタイプ、デバイス条件などをフィルターとして設定。
        * アクション（ブロック、監視、ファイルスキャンなど）を指定。
    * `[スクリーンショット：Entra ID条件付きアクセスでのセッション制御設定と、MDCAセッションポリシー作成画面]`
* **注意点**: リバースプロキシ方式のため、一部のアプリケーションとの互換性やパフォーマンスに影響が出る可能性があります。十分なテストが必要です。

### ハンズオン演習アイデア

* **演習3.13: Cloud Discoveryレポートの確認 (ログファイルがあれば)**
    * (サンプルログファイルがあれば、それをMDCAにアップロードして) Cloud Discoveryダッシュボードで検出されたアプリ、リスクスコア、利用ユーザー数などを確認する。
    * 特定のアプリ（例: 未承認のファイル共有サービス）を「未承認」としてタグ付けしてみる。
* **演習3.14: アプリコネクタの接続 (Microsoft 365 の場合)**
    1.  Defender ポータルで、Defender for Cloud Appsのアプリコネクタ設定画面を開く。
    2.  「Office 365」アプリ（またはMicrosoft 365）が接続済みであることを確認する（通常は自動的に接続されるか、簡単な手順で接続可能）。
    3.  接続されている場合、収集されているアクティビティログのサンプルをいくつか確認する。
* **演習3.15: アクティビティポリシーの作成 (シミュレーション)**
    1.  「管理者による特権ロールの割り当て」アクティビティを検出したら、高重要度のアラートを生成するアクティビティポリシーを作成するシナリオを考える。
    2.  ポリシーのフィルター条件（アクティビティタイプ、管理者ユーザーなど）とアクション（アラート）をどのように設定するかを設計する。
* **演習3.16: 条件付きアクセスアプリ制御の概念理解**
    * アンマネージドデバイスからSharePoint Onlineにアクセスしたユーザーが、特定の秘密度ラベルが付いたファイルをダウンロードしようとしたらブロックする、というシナリオを考える。
    * このシナリオを実現するために、Entra ID 条件付きアクセスポリシーとMDCAセッションポリシーがどのように連携して動作するかを説明する。

---
