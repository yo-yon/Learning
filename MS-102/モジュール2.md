# モジュール2: Microsoft Entra ID による ID とアクセスの実装と管理 (試験比重: 25-30%)

## はじめに (モジュール2の学習を始めるにあたって)

このモジュールでは、Microsoft 365 のID管理の中核となる Microsoft Entra ID (旧称 Azure Active Directory) に焦点を当てます。オンプレミス Active Directory とのID同期、ユーザー認証の強化（MFA、SSPR）、そして条件付きアクセスやID保護を用いたセキュアなアクセス制御の実装方法について深く学びます。Microsoft 365 環境全体のセキュリティと利便性を両立させる上で非常に重要なモジュールです。

**学習目標:**

* オンプレミスActive DirectoryとMicrosoft Entra ID間のID同期ソリューション（Entra Connect Sync, Entra Connect Cloud Sync）を理解し、実装・管理できる。
* 多要素認証(MFA)、セルフサービスパスワードリセット(SSPR)、パスワード保護などの認証機能を構成し、管理できる。
* 条件付きアクセスポリシーを設計・実装し、様々な条件下でのアクセス制御を実現できる。
* Microsoft Entra ID Protectionを活用して、IDベースのリスクを検出し対応できる。
* 外部ID（B2Bゲストユーザー）の招待とアクセス管理、クロステナントアクセス設定を構成できる。

---

## 2.1 ID 同期の実装と管理 (Microsoft Entra Connect Sync / Cloud Sync)

### ID 同期の概要と目的

* **ID同期とは**: オンプレミスの Active Directory Domain Services (AD DS) に存在するユーザー、グループ、デバイスなどのID情報を、クラウドベースの Microsoft Entra ID に同期（コピーまたは連携）するプロセスです。
* **目的**:
    * **ハイブリッドIDの実現**: オンプレミスとクラウドで一貫したID情報を維持します。
    * **シングルサインオン(SSO)の基盤**: ユーザーはオンプレミスと同じ資格情報（またはそれに近い形）でMicrosoft 365サービスにアクセスできます。
    * **ID管理の一元化（部分的に）**: ユーザーアカウントの作成や主要な属性変更はオンプレミスADで行い、それがEntra IDに反映される運用が一般的です（書き戻し機能もあり）。
    * **Microsoft 365サービスの利用**: Entra IDに同期されたIDを使用して、Exchange Online、SharePoint Online、Teamsなどのサービスを利用します。

### Microsoft Entra Connect Sync とは？

* **概要**: オンプレミス環境にインストールするサーバーコンポーネント（同期エンジン）を通じて、AD DSとEntra ID間でID情報を同期する、従来から提供されている主要な同期ソリューションです。
* **特徴**:
    * **高機能**: 詳細な同期ルールのカスタマイズ、複雑なフォレスト構成、書き戻し機能（パスワード、デバイス、グループなど）をサポートします。
    * **柔軟性**: フィルタリングオプション（OU、属性）が豊富です。
    * **実績**: 多くの組織で長年利用されています。
* **主要コンポーネント**:
    * **Synchronization Engine**: 実際の同期処理を実行します。
    * **SQL Server Database**: 同期構成情報やメタバース（ID情報の中間表現）を格納します（Express版が同梱、大規模環境では別途Full SQL Serverが必要）。
    * **Connectors (Management Agents)**: オンプレミスADやEntra IDとの間でデータをやり取りします。
    * **Synchronization Service Manager**: 同期状態の確認や手動同期の実行、コネクタースペースの確認などを行う管理UIです。
    * **Synchronization Rules Editor**: 同期ルール（属性フロー、スコープなど）を詳細にカスタマイズするツールです。
* **アーキテクチャ概要**:
    * `[図：Microsoft Entra Connect Sync の基本アーキテクチャ図。オンプレミスAD、Entra Connectサーバー(Sync Engine, SQL DB)、Microsoft Entra ID間のデータの流れを示す]`

### Microsoft Entra Connect Cloud Sync とは？

* **概要**: オンプレミス環境に軽量なプロビジョニングエージェントをインストールし、同期の構成と管理はMicrosoft Entra管理センター（クラウド）から行う、新しい世代の同期ソリューションです。
* **特徴**:
    * **シンプル**: Entra Connect Syncに比べて構成や管理が簡素化されています。
    * **軽量エージェント**: 複数のエージェントをインストールして冗長性を確保できます。
    * **クラウド管理**: 同期設定の変更などがクラウドから行えます。
    * **特定のシナリオに強み**:
        * Active Directoryフォレストが切断されている（信頼関係がない）環境からの同期。
        * オンプレミスADからEntra IDへのユーザー/グループの直接プロビジョニング。
        * 既存のEntra Connect Sync環境と並行して、一部のOUをCloud Syncで管理する（段階的移行など）。
* **主要コンポーネント**:
    * **Microsoft Entra Connect Provisioning Agent**: オンプレミスADとEntra ID間の通信を担う軽量なエージェント。
    * **Cloud-based Synchronization Engine**: 実際の同期ロジックはクラウド側で実行されます。
    * **Microsoft Entra Admin Center**: 同期構成、エージェント管理、監視を行います。
* **アーキテクチャ概要**:
    * `[図：Microsoft Entra Connect Cloud Sync の基本アーキテクチャ図。オンプレミスAD、Provisioning Agent、Microsoft Entra ID間のデータの流れとクラウドからの構成管理を示す]`

### Entra Connect Sync と Cloud Sync の比較と選択基準

| 機能/側面             | Microsoft Entra Connect Sync                     | Microsoft Entra Connect Cloud Sync                 | 備考                                                                 |
| ----------------------- | ------------------------------------------------ | -------------------------------------------------- | -------------------------------------------------------------------- |
| **基本アーキテクチャ** | オンプレミスサーバー中心                               | クラウド中心、軽量エージェント                         |                                                                      |
| **管理インターフェース** | オンプレミスサーバー上のツール群                     | Microsoft Entra 管理センター                       |                                                                      |
| **複雑なフォレスト構成**| サポート (マルチフォレスト、信頼関係あり/なし)     | マルチフォレスト（切断）サポート、よりシンプルに      | Cloud Syncは切断フォレストが得意                                       |
| **同期オブジェクト** | ユーザー, グループ, デバイス, 連絡先など広範       | ユーザー, グループ (デバイス同期は限定的/ロードマップ) | Cloud Syncの対象オブジェクトは拡大中                                     |
| **パスワードハッシュ同期**| 可                                               | 可                                                 |                                                                      |
| **パススルー認証(PTA)** | 可                                               | 可 (エージェント経由)                               |                                                                      |
| **フェデレーション(AD FS)**| 可 (AD FS連携構成をサポート)                     | 不可 (AD FS連携はEntra Connect Syncが必要)           |                                                                      |
| **シームレスSSO** | 可                                               | 可                                                 |                                                                      |
| **書き戻し機能** | パスワード, デバイス, グループ, 属性など豊富       | パスワード (限定的), グループ (限定的/ロードマップ)      | Entra Connect Syncが書き戻し機能は優位                                 |
| **フィルタリング** | OU, 属性, ドメインなど詳細                       | OU, 属性 (よりシンプル)                              |                                                                      |
| **同期ルールのカスタマイズ**| 詳細なカスタマイズが可能 (Sync Rules Editor)   | 限定的 (属性マッピングなど)                          | 複雑な変換ロジックはEntra Connect Sync                                 |
| **ステージングモード** | 可                                               | 不可 (エージェントのグループ化で類似の段階展開は可能) |                                                                      |
| **インストール要件** | ドメイン参加サーバー、SQL Express/Full SQL         | 軽量エージェント (ドメイン参加/非参加サーバーも可)    | Cloud Syncはインフラ要件が低い                                       |
| **自動アップグレード** | 部分的にサポート (設定による)                      | エージェントは自動アップグレード                       |                                                                      |

* **選択基準のポイント**:
    * **既存環境**: 既にEntra Connect Syncが稼働している場合は、移行の必要性を慎重に評価します。
    * **複雑性**: 複雑な同期ルール、詳細なフィルタリング、豊富な書き戻し機能が必要な場合はEntra Connect Sync。
    * **インフラ**: オンプレミスサーバーの制約が大きい、または切断フォレスト環境の場合はCloud Syncが有利。
    * **シンプルさ**: 簡単な導入とクラウドベースの管理を優先するならCloud Sync。
    * **Microsoftの推奨**: 新規構築で要件が合致すればCloud Syncも有力な選択肢。両者の機能を理解し、組織の要件に合わせて選択します。

### インストールの準備 (Entra Connect Sync 中心に解説)

* **オンプレミスActive Directoryの準備**:
    * **フォレスト/ドメイン機能レベル**: サポートされているレベルであることを確認 (Windows Server 2003以降が一般的だが、最新情報を確認)。
    * **スキーマ拡張**: Exchangeハイブリッドなどの特定の機能を利用する場合、ADスキーマの拡張が必要な場合があります。Entra Connect Sync自体がスキーマを拡張することはありません。
    * **IdFixツールの実行**:
        * **目的**: 同期前にオンプレミスAD内のオブジェクト（ユーザー、グループ）の属性値に問題（重複、不正な文字、フォーマットエラーなど）がないか検出し、修正を支援します。これにより、同期エラーを未然に防ぎます。
        * **主なチェック項目**: `proxyAddresses`, `userPrincipalName`, `mail`, `displayName` などの属性の重複や不正。
        * **使用手順**:
            1.  Microsoft Download CenterからIdFixツールをダウンロードし、ドメインコントローラーまたはドメインメンバーサーバーで実行します。
            2.  ADに接続し、スキャンを実行します。
            3.  エラーが検出された場合、推奨される修正アクションを確認し、適用します。
            * `[スクリーンショット：IdFixツールの実行結果画面例]`
* **Entra Connect Syncサーバーの準備**:
    * **OS**: サポートされているWindows Serverバージョン (最新情報を確認)。
    * **ドメイン参加**: オンプレミスADドメインに参加している必要があります。
    * **.NET Framework, PowerShell**: 必要なバージョンがインストールされていること。
    * **リソース**: CPU、メモリ、ディスク容量（同期するオブジェクト数に応じて推奨値を確認）。
    * **インターネット接続**: Microsoft 365のエンドポイントへのHTTPS(443)アウトバウンド通信許可。
* **必要なアカウントと権限**:
    * **オンプレミスAD用**:
        * Enterprise Adminsグループのメンバーアカウント（初回インストール時、またはフォレスト構成の変更時）。
        * または、事前に準備されたADアカウントに適切な権限を委任（推奨）。Entra Connect SyncがADとの通信に使用するサービスアカウント(MSOL_xxxx)が自動作成されるか、既存のアカウントを指定します。
    * **Microsoft Entra ID用**:
        * グローバル管理者ロールを持つアカウント（初回インストール時、またはEntra IDとの接続構成変更時）。
        * Entra Connect SyncがEntra IDとの通信に使用するサービスアカウントが自動作成されます。
* **SQL Serverの考慮**:
    * オブジェクト数が10万未満の場合、通常は同梱されるSQL Server Expressで十分です。
    * 10万以上の場合は、別途Standard以上のSQL Serverインスタンス（ローカルまたはリモート）を準備することを検討します。

### Microsoft Entra Connect Sync のインストールと構成

* **インストールウィザードの起動**: Microsoft Download Centerから最新版のEntra Connect Syncをダウンロードし、準備したサーバーで実行します。
* **モード選択**:
    * **簡単設定 (Express Settings)**: 単一ADフォレストで、パスワードハッシュ同期と一般的な設定を迅速に構成します。最も一般的なシナリオ向け。
    * **カスタム設定 (Customize)**: 複数のADフォレスト、特定の認証方法（PTA, AD FS）、フィルタリング、同期オプションのカスタマイズなど、詳細な構成が可能です。
* **カスタム設定の主要ステップ**:
    1.  **必要なコンポーネントのインストール**: 不足しているコンポーネントがあればインストールされます。
    2.  **ユーザーサインイン**:
        * **パスワードハッシュ同期 (PHS)**: オンプレミスADのパスワードハッシュをEntra IDに同期します。Entra IDが認証を行います。シームレスSSOと組み合わせ可能。
        * **パススルー認証 (PTA)**: Entra IDが認証要求をオンプレミスADに「パススルー」し、オンプレミスADが認証を行います。軽量なエージェントをオンプレミスに複数台インストールします。シームレスSSOと組み合わせ可能。
        * **フェデレーション (AD FSなど)**: 認証をオンプレミスのIDプロバイダー（例: AD FS）に委任します。
        * **構成しない**: サインイン方法を別途構成する場合。
        * **シングルサインオン (SSO) の有効化**: シームレスSSOを有効にすると、ドメイン参加済みPCから社内ネットワーク経由でアクセスする際に、ユーザーは資格情報を再入力することなくMicrosoft 365リソースにアクセスできます。
        * `[スクリーンショット：ユーザーサインイン方法の選択画面]`
    3.  **Microsoft Entra ID に接続**: Entra IDのグローバル管理者アカウントでサインインします。
    4.  **ディレクトリの接続**:
        * オンプレミスADフォレストを追加し、ADのエンタープライズ管理者アカウント（または適切な権限を持つアカウント）で接続します。
        * 複数のフォレストを追加することも可能です。
        * `[スクリーンショット：ディレクトリ接続（フォレスト追加）画面]`
    5.  **Microsoft Entra サインイン構成**:
        * **ユーザープリンシパル名 (UPN)**: Entra IDでのユーザーのサインインIDとなるオンプレミスADの属性を選択します（通常は `userPrincipalName`）。
        * **ソースアンカー (Source Anchor)**: オンプレミスADオブジェクトとEntra IDオブジェクトを一意に関連付けるための不変の属性（通常は `objectGUID` を `ms-DS-ConsistencyGuid` に変換して使用）。慎重に選択し、後から変更は困難です。
    6.  **ドメインとOUのフィルタリング**:
        * 特定のドメイン全体を同期するか、選択したOUのみを同期するかを指定できます。
        * `[スクリーンショット：OUフィルタリング設定画面]`
    7.  **ユーザーの一意な識別**: 複数のフォレストがある場合のユーザー照合方法などを設定します。
    8.  **オプション機能**:
        * **Exchange ハイブリッド展開**: オンプレミスExchangeとExchange Onlineの共存環境をサポート。
        * **パスワードライトバック**: Entra IDで変更されたパスワード（SSPRなど）をオンプレミスADに書き戻します（Premiumライセンスが必要）。
        * **グループライトバック**: Entra IDで作成されたMicrosoft 365グループをオンプレミスADに配布グループとして書き戻します（Premiumライセンスが必要）。
        * **デバイスライトバック**: Entra ID Hybrid JoinデバイスをオンプレミスADに書き戻します（条件付きアクセスなどで利用）。
        * **ディレクトリ拡張機能の同期**: オンプレミスADで拡張したカスタム属性をEntra IDに同期します。
        * `[スクリーンショット：オプション機能の選択画面]`
    9.  **構成の準備完了**: 設定内容を確認し、`[インストール]` をクリックします。
    10. **ステージングモード**: 本番環境に影響を与えずに同期設定をテスト・検証するために、Entra Connect Syncをステージングモードでインストールできます。このモードでは、Entra IDへのエクスポートは行われません。設定検証後、アクティブなサーバーに切り替えます。

### Microsoft Entra Connect Cloud Sync のエージェントインストールと構成

1.  **エージェントのダウンロード**: Microsoft Entra 管理センターからプロビジョニングエージェントをダウンロードします。
2.  **エージェントのインストール**: オンプレミスのWindows Server（ドメイン参加推奨）にエージェントをインストールします。ウィザードに従い、Entra IDのグローバル管理者とオンプレミスADのエンタープライズ管理者の資格情報を提供します。
3.  **Microsoft Entra 管理センターでの構成**:
    * `[ハイブリッド管理]` > `[Microsoft Entra Connect]` > `[Cloud Sync]` に移動します。
    * `[新しい構成]` をクリックし、同期するADドメインを選択します。
    * **スコープフィルタリング**: 同期するOUやセキュリティグループを指定します。
    * **属性マッピング**: 必要に応じて、AD属性とEntra ID属性のマッピングをカスタマイズします。
    * パスワードハッシュ同期を有効にします。
    * 構成を保存し、有効化します。
    * `[スクリーンショット：Cloud Syncの構成画面 (Entra管理センター)]`

### 同期の監視

* **Synchronization Service Manager (Entra Connect Sync のみ)**:
    * Entra Connect Syncサーバーで起動します。
    * `[操作]` タブ: 各コネクタ（AD, Entra ID）の実行プロファイル（インポート, 同期, エクスポート）の履歴と結果（成功、エラーありなど）を確認できます。
        * `[スクリーンショット：Synchronization Service Manager の操作タブ]`
    * **メタバース検索**: 特定のオブジェクトがどのように同期されているか（属性フローなど）を追跡できます。
    * **コネクタースペースオブジェクトのプロパティ**: 各コネクタースペース内のオブジェクトの属性値や接続状態を確認できます。
* **Microsoft Entra Connect Health**:
    * **目的**: クラウドベースの監視ソリューション。Entra Connect SyncサーバーおよびAD FSサーバーの正常性、パフォーマンス、同期アクティビティを監視します。
    * **主な機能**:
        * 同期サービスの正常性（最新の同期時刻、エラー数など）。
        * 同期エラーの詳細レポート（オブジェクトレベル）。
        * エージェントの正常性（Cloud Syncエージェントも含む）。
        * リスクの高いAD FSアプリケーションの検出。
        * 使用状況分析（パスワードリセット、デバイス登録など）。
        * アラート通知（重大なエラー発生時など）。
    * **アクセス**: Microsoft Entra 管理センター > `[監視と正常性]` > `[Connect Health]`。
        * `[スクリーンショット：Connect Health ダッシュボードの概要]`
    * エージェントのインストール: Connect Healthを利用するには、監視対象サーバー（Entra Connect Syncサーバー、AD FSサーバー、Web Application Proxyサーバー、AD DSドメインコントローラー）にHealth Agentをインストールする必要があります。
* **一般的な同期エラーとその対処**:
    * **重複属性 (AttributeValueMustBeUnique)**: `proxyAddresses` や `userPrincipalName` などが一意でない場合に発生。IdFixツールやオンプレミスADでの修正が必要です。
    * **データ検証エラー (DataValidationFailed)**: 属性値がEntra IDの要件を満たしていない（長すぎる、不正な文字が含まれるなど）。
    * **大規模な削除の防止**: 誤操作による大量削除を防ぐため、一定数以上のオブジェクトが削除されようとすると同期が停止する機能。しきい値は変更可能ですが、意図した削除であることを確認してから再開します。
    * **トラブルシューティングの基本**:
        1.  エラーメッセージの詳細を確認 (Connect Health, Synchronization Service Manager)。
        2.  影響を受けているオブジェクトを特定。
        3.  オンプレミスADのデータを確認・修正 (IdFixなど)。
        4.  必要に応じて完全同期を実行。
        5.  Microsoftのトラブルシューティングドキュメントを参照。

### 同期ルールの管理 (Entra Connect Sync)

* **目的**: 属性がオンプレミスADからMicrosoft Entra IDへどのように流れるか（変換されるか）を定義・カスタマイズします。
* **Synchronization Rules Editor**:
    * Entra Connect Syncサーバーで起動します。
    * **方向**: 受信 (Inbound)、送信 (Outbound)。
    * **ルールタイプ**: 参加 (Join)、プロビジョニング (Provision)、変換 (Transformation)。
    * **既定のルール**: 多数の既定ルールが存在し、基本的な同期処理を担っています。これらのルールは直接編集せず、コピーして優先度の高い新しいルールを作成することが推奨されます。
    * `[スクリーンショット：Synchronization Rules Editor の画面]`
* **一般的なカスタマイズ例**:
    * 特定の属性を同期対象から除外する（値をNULLにする）。
    * オンプレミスADの属性値を変換してEntra IDの属性にマッピングする（例: `employeeID` を `extensionAttribute1` にマッピング）。
    * 特定の条件を満たすユーザーのみを同期する（より高度な属性ベースフィルタリング）。
* **注意点**: 同期ルールの変更はテナント全体の同期動作に大きな影響を与える可能性があるため、十分なテストと理解が必要です。変更後は完全同期が必要になる場合があります。

### ハンズオン演習アイデア

* **演習2.1: IdFixツールの実行と結果分析 (概念・デモ)**
    * (実際のオンプレミスAD環境がない場合) Microsoft Learnのドキュメントやデモ動画を参考に、IdFixツールがどのような問題を検出し、どのように修正を支援するかを理解する。
* **演習2.2: Entra Connect Sync インストールオプションの検討**
    * 組織のシナリオ（例: 単一フォレストでパスワードハッシュ同期、特定のOUのみ同期したい）を想定し、Entra Connect Syncのインストールウィザードでどのオプションを選択すべきかをディスカッションまたは記述する。
    * なぜそのオプション（簡単設定かカスタム設定か、どの認証方法か、どのフィルタリングか）を選択するのか理由を説明する。
* **演習2.3: Synchronization Service Managerの操作 (概念・デモ)**
    * ドキュメントやデモ動画を参考に、Synchronization Service Managerの「操作」タブで表示される情報（インポート、同期、エクスポートの各ステップ、成功/エラー）の意味を理解する。
    * 「メタバース検索」で特定のユーザーオブジェクトがどのように処理されているかを確認する手順を把握する。
* **演習2.4: Microsoft Entra Connect Healthダッシュボードの探索**
    * (開発者テナント等でConnect Healthが利用可能であれば) 実際にダッシュボードを開き、どのような監視項目（同期サービス、AD FS、エージェントなど）があるかを確認する。
    * 同期エラーが表示されている場合、その詳細を確認する手順を追う。
    * 利用可能なレポート（リスクの高いAD FSアプリなど）を確認する。
* **演習2.5: (可能であれば) Cloud Syncエージェントのインストールと基本構成**
    * テスト用のオンプレミスサーバー（仮想マシンなど）にCloud Syncエージェントをインストールする。
    * Microsoft Entra管理センターで、特定のOUのユーザーを同期する基本的な構成プロファイルを作成し、有効化してみる。
    * 同期されたユーザーをEntra IDで確認する。

---

## 2.2 認証の実装と管理

### 多要素認証 (MFA) の重要性と仕組み

* **重要性**:
    * パスワードだけでは不十分。パスワード漏洩、ブルートフォース攻撃、フィッシングなどにより、パスワードは容易に侵害される可能性があります。
    * MFAは、ID侵害のリスクを99.9%以上削減すると言われています (Microsoft調べ)。
    * コンプライアンス要件（PCI DSS, HIPAAなど）でMFAが要求されることもあります。
* **仕組み (認証要素)**:
    * ユーザーが本人であることを証明するために、複数の異なる種類の要素を組み合わせます。
    * **知識要素 (Something you know)**: パスワード、PIN。
    * **所持要素 (Something you have)**: スマートフォン (Authenticatorアプリ、SMS、音声通話)、ハードウェアトークン、FIDO2セキュリティキー。
    * **生体要素 (Something you are)**: 指紋認証、顔認証 (Windows Hello for Businessなど)。
    * MFAでは、これらの要素のうち2つ以上を要求します。

### MFA の展開方法

* **セキュリティの既定値群 (Security Defaults)**:
    * **概要**: Microsoftが推奨する基本的なセキュリティ設定を、簡単なトグルスイッチ一つでテナント全体に有効化する機能です。
    * **MFAに関する動作**:
        * すべての管理者ロールを持つアカウントにMFAを要求します。
        * すべてのユーザーにMFA登録を促し、リスクの高いサインイン時にMFAを要求します。
        * レガシー認証プロトコルをブロックします。
    * **対象**: 主に中小規模組織や、複雑な設定なしに基本的な保護を迅速に導入したい場合に適しています。
    * **注意点**: 条件付きアクセスポリシーとは併用できません。セキュリティの既定値群を有効にすると、既存の条件付きアクセスポリシーは無効になります。より詳細な制御が必要な場合は、セキュリティの既定値群を無効にし、条件付きアクセスポリシーでMFAを構成します。
    * **有効化手順**: Microsoft Entra 管理センター > `[プロパティ]` > `[セキュリティの既定値群の管理]`。
        * `[スクリーンショット：セキュリティの既定値群の有効化トグル]`
* **条件付きアクセスポリシー (Conditional Access Policies) - 推奨**:
    * **概要**: 「もし(If)～ならば(Then)～」のロジックに基づき、特定の条件下でMFAを要求するなど、きめ細かいアクセス制御を実現します。
    * **利点**: ユーザー、グループ、アプリケーション、場所、デバイス状態、サインインリスクなど、様々な条件を組み合わせてMFAの適用範囲を柔軟に制御できます。
    * **設定例**:
        * すべてのユーザーに対して、すべてのクラウドアプリへのアクセス時にMFAを要求。
        * 管理者ロールを持つユーザーに対して、Azure portalへのアクセス時にMFAを要求。
        * 信頼されていないネットワークからのアクセス時にMFAを要求。
    * *詳細はセクション2.3で解説します。*
* **ユーザーごとのMFA (Per-user MFA) - レガシー、非推奨**:
    * **概要**: 各ユーザーアカウントに対して個別にMFAの状態（有効、強制、無効）を設定する方法です。
    * **問題点**: 管理が煩雑でスケーラビリティが低く、柔軟な制御が困難です。セキュリティの既定値群や条件付きアクセスポリシーへの移行が強く推奨されています。
    * **確認場所**: Microsoft 365 管理センターのユーザー設定、またはAzure portalのレガシーMFA管理ポータル。

### 利用可能な認証方法

* **Microsoft Authenticator アプリ**:
    * **プッシュ通知 (Push Notification)**: サインイン時にスマートフォンに通知が送信され、アプリで「承認」をタップします。
    * **パスワードレスサインイン (Passwordless Phone Sign-in)**: ユーザー名入力後、Authenticatorアプリに表示される番号とPC画面の番号を一致させるか、生体認証でサインインします。パスワード入力が不要になります。
    * **ワンタイムパスコード (TOTP - Time-based One-Time Password)**: アプリが30秒または60秒ごとに生成する6桁または8桁のコードを入力します。オフラインでも利用可能です。
    * **推奨**: プッシュ通知とパスワードレスサインインは、利便性とセキュリティのバランスが良い主要なMFA方法です。
* **FIDO2 セキュリティキー**:
    * USB、NFC、Bluetooth接続の物理的なセキュリティキー。
    * 非常に強力なフィッシング耐性を持ちます。
    * パスワードレス認証を実現できます。
* **Windows Hello for Business**:
    * Windowsデバイスに統合された生体認証（顔、指紋）またはPIN。
    * デバイス自体が強力な2要素目として機能します。
* **OATH ハードウェア/ソフトウェアトークン**:
    * 専用のハードウェアデバイスまたはサードパーティの認証アプリが生成するTOTP。
    * スマートフォンを持たないユーザーや、特定の規制要件がある場合に利用されます。
* **SMS (テキストメッセージ)**:
    * 登録した電話番号にワンタイムコードが送信されます。
    * **セキュリティ上の懸念**: SIMスワップ攻撃などのリスクがあり、他の方法が利用可能であれば優先度は低くなります。
* **音声通話 (Voice Call)**:
    * 登録した電話番号に自動音声でワンタイムコードが通知されるか、キーパッド操作を求められます。
    * **セキュリティ上の懸念**: SMSと同様のリスクに加え、応答環境のプライバシーも考慮が必要です。

### 認証方法ポリシーの構成

* **目的**: テナント全体でユーザーがMFAやSSPRに登録・使用できる認証方法を制御します。
* **アクセス場所**: Microsoft Entra 管理センター > `[保護]` > `[認証方法]` > `[ポリシー]`。
    * `[スクリーンショット：認証方法ポリシーの一覧画面]`
* **設定項目**:
    * 各認証方法（FIDO2セキュリティキー、Microsoft Authenticator、SMSなど）ごとに、有効/無効、対象ユーザー/グループを指定できます。
    * Microsoft Authenticator の詳細設定（プッシュ通知の許可、パスワードレスの有効化、場所やアプリケーション名のコンテキスト表示など）。
    * SMSや音声通話の利用を特定のグループに限定するなどの制御が可能です。
* **移行**: 従来のレガシーMFA設定やSSPR設定から、この認証方法ポリシーへの移行が推奨されています。

### セルフサービスパスワードリセット (SSPR) の構成

* **目的**: ユーザーがITヘルプデスクに頼ることなく、自身で忘れたパスワードを安全にリセットできるようにします。これにより、ヘルプデスクの負荷軽減とユーザーの利便性向上が期待できます。
* **有効化と対象ユーザー**:
    * SSPRを有効にする対象グループ（すべて、選択したグループ、なし）を選択します。
    * `[スクリーンショット：SSPR有効化設定画面]`
* **登録に必要な認証方法**:
    * ユーザーがSSPRを利用するために事前に登録しておく必要がある認証方法の「数」と「種類」を指定します。
    * **推奨**: 2つ以上の方法を要求することでセキュリティを高めます（例: Authenticatorアプリ + SMS）。
    * 利用可能な方法は、認証方法ポリシーで許可されているものに限られます。
    * `[スクリーンショット：SSPRの認証方法設定画面]`
* **パスワードライトバック (Password Writeback)**:
    * **機能**: Entra ID上でユーザーがSSPRを利用してパスワードを変更した際に、その新しいパスワードをオンプレミスAD DSにも書き戻し、同期します。
    * **前提条件**: Microsoft Entra Connect Sync がインストールされ、パスワードライトバック機能が有効になっていること。Premium P1以上のライセンスが必要です。
    * **重要性**: ハイブリッド環境でパスワードの一貫性を保つために不可欠です。
* **通知設定**: ユーザーや管理者にパスワードリセットに関する通知を行うか設定します。
* **カスタマイズ**: ヘルプデスクのリンクや連絡先情報を表示できます。
* **ユーザーエクスペリエンス**:
    * **登録**: 初回またはMFA登録時に、SSPR用の認証方法を登録するよう促されます (aka.ms/mysecurityinfo または aka.ms/mfasetup)。
    * **リセット**: サインイン画面の「パスワードを忘れた場合」リンクから、登録した認証方法で本人確認を行い、新しいパスワードを設定します。

### Microsoft Entra パスワード保護

* **目的**: 推測されやすい脆弱なパスワードや、組織に関連するキーワードを含むパスワードの使用を禁止し、パスワード強度を高めます。
* **Azure AD パスワード保護 (クラウドユーザー向け)**:
    * Microsoftが管理するグローバル禁止パスワードリスト（一般的な脆弱パスワード）が自動的に適用されます。
    * **カスタム禁止パスワードリスト**: 組織固有の単語（会社名、製品名、地名など）を最大1000語まで登録し、それらがパスワードに含まれることを禁止できます。
    * **設定場所**: Microsoft Entra 管理センター > `[保護]` > `[認証方法]` > `[パスワード保護]`。
        * `[スクリーンショット：パスワード保護のカスタム禁止リスト設定画面]`
    * **ロックアウトしきい値**: パスワードスプレー攻撃などを緩和するため、不正なパスワード試行回数に基づくアカウントロックアウトの設定もここで行います。
* **オンプレミス AD DS 用の Azure AD パスワード保護**:
    * **機能**: クラウドで設定した禁止パスワードポリシー（グローバルリスト + カスタムリスト）を、オンプレミスADのパスワード変更・設定時にも適用します。
    * **前提条件**:
        * Microsoft Entra Connect Sync が稼働していること。
        * オンプレミスの各ドメインコントローラーに「Azure AD Password Protection DC agent」をインストール。
        * フォレスト内のPDCエミュレーターロールを持つDCに「Azure AD Password Protection proxy service」をインストール（またはEntra Connect Syncサーバーに同居も可）。
        * Premium P1以上のライセンス。
    * **メリット**: オンプレミスADのパスワードポリシーをクラウドと連携して強化できます。

### 認証に関する問題のトラブルシューティング

* **Microsoft Entra ID サインインログ**:
    * **確認場所**: Microsoft Entra 管理センター > `[監視と正常性]` > `[サインインログ]`。
    * **主要情報**: 日時、ユーザー、アプリケーション、IPアドレス、場所、状態（成功/失敗）、エラーコード、認証要件（MFAなど）、条件付きアクセスポリシーの評価結果など。
    * 失敗したサインインの詳細を確認することで、原因究明の手がかりが得られます。
        * `[スクリーンショット：サインインログの詳細表示画面]`
* **MFA登録状況の確認**:
    * ユーザーごとのMFA登録済み認証方法を確認できます。
    * `[ユーザー]` > 対象ユーザー選択 > `[認証方法]`。
* **SSPR登録状況**: 同様にユーザーの認証方法から確認できます。
* **監査ログ**: MFAやSSPRの設定変更、ユーザーによる認証方法の登録・変更などのアクティビティが記録されます。

### ハンズオン演習アイデア

* **演習2.6: セキュリティの既定値群の有効化とMFA体験**
    1.  (開発者テナントで、条件付きアクセスポリシーが未構成の場合) セキュリティの既定値群を有効にする。
    2.  新しいテストユーザーで初めてサインインし、Microsoft AuthenticatorアプリによるMFA登録を求められるプロセスを体験する。
    3.  管理者アカウントでサインインする際にもMFAが要求されることを確認する。
    4.  (確認後) セキュリティの既定値群を無効にする（次の演習のため）。
* **演習2.7: SSPRの構成と利用体験**
    1.  SSPRを特定のテストユーザーグループに対して有効にする。
    2.  認証方法として「モバイルアプリの通知」と「電子メール」を2つ要求するように設定する。
    3.  対象のテストユーザーで `aka.ms/mysecurityinfo` にアクセスし、MFAとSSPR用の認証方法（Authenticatorアプリと代替メールアドレス）を登録する。
    4.  サインイン画面から「パスワードを忘れた場合」を選択し、実際にパスワードリセットプロセスを実行してみる。
* **演習2.8: Microsoft Authenticatorによるパスワードレスサインインの設定と体験**
    1.  認証方法ポリシーで、特定のテストユーザーグループに対してMicrosoft Authenticatorのパスワードレスサインインを有効にする。
    2.  対象のテストユーザーでMicrosoft Authenticatorアプリをセットアップし、パスワードレスサインインを有効化する。
    3.  PCのブラウザからMicrosoft 365にサインインする際に、ユーザー名入力後にパスワード入力の代わりにAuthenticatorアプリへの通知（番号一致など）でサインインできることを体験する。
* **演習2.9: カスタム禁止パスワードリストの設定**
    1.  Azure ADパスワード保護で、カスタム禁止パスワードリストに「Contoso」や「Password」などの単語をいくつか追加する。
    2.  クラウド上のテストユーザーが、これらの単語を含む新しいパスワードに変更しようとするとブロックされることを確認する。

---

## 2.3 セキュアアクセスの実装と管理

### 条件付きアクセスポリシーの概要と基本要素 (再掲と深掘り)

* **目的**: 適切なアクセス条件に基づいて、組織のリソース（アプリケーション、データ）へのアクセスを保護するための強力なツールです。ゼロトラストセキュリティモデルの中核的な要素の一つ。
* **基本ロジック**: 「**もし (If)** 一連の条件（シグナル）が満たされたら、**ならば (Then)** アクセス制御（アクション）を適用する」
* **シグナル (条件 - Assignments & Conditions)**: ポリシーが評価する要素。
    * **ユーザーまたはワークロードID (Users or workload identities)**:
        * 特定のユーザー、グループ（セキュリティグループ、Microsoft 365 グループ）、ディレクトリロール（グローバル管理者など）。
        * ワークロードID（サービスプリンシパル、マネージドID）。
        * ゲストユーザーや外部ユーザー。
        * 除外設定も可能（特定のユーザーやロールをポリシー対象外にする）。
    * **クラウドアプリケーションまたはアクション (Cloud apps or actions)**:
        * 対象となるアプリケーション（例: Office 365スイート、Azure portal、特定のSaaSアプリ、カスタムアプリ）。
        * 「すべてのクラウドアプリ」も選択可能（影響範囲大のため注意）。
        * ユーザーアクション（例: セキュリティ情報の登録）。
    * **条件 (Conditions)**:
        * **サインインリスク (Sign-in risk)**: Microsoft Entra ID Protectionが検出したサインイン試行のリスクレベル（低、中、高）。
        * **ユーザーリスク (User risk)**: Microsoft Entra ID Protectionが検出したユーザーアカウント侵害のリスクレベル。
        * **デバイスプラットフォーム (Device platforms)**: OSの種類（Windows, macOS, iOS, Android, Linux）。
        * **場所 (Locations)**:
            * 信頼できるIPアドレス範囲（名前付き場所として定義）。
            * 特定の国/地域（GPSまたはIPベース）。
            * MFA信頼済みIP（レガシー、非推奨）。
        * **クライアントアプリ (Client apps)**:
            * ブラウザー。
            * モバイルアプリとデスクトップクライアント（先進認証対応/非対応）。
            * Exchange ActiveSyncクライアント。
            * その他のクライアント（レガシー認証プロトコルを使用するものなど）。
        * **フィルター処理されたデバイス (Filter for devices)**: デバイスの属性（`displayName`, `isCompliant`など）に基づいて、より細かく対象デバイスをフィルタリング。
        * `[図：条件付きアクセスポリシーのシグナル（条件）の全体像]`
* **アクセス制御 (Access Controls)**: シグナル（条件）に一致した場合に適用されるアクション。
    * **許可 (Grant)**:
        * アクセスを許可するが、以下のいずれかまたは複数の要件を満たす必要がある。
            * **多要素認証を要求する (Require multifactor authentication)**: 最も一般的な制御。
            * **準拠しているとしてマークされているデバイスを要求する (Require device to be marked as compliant)**: Intuneなどで管理され、コンプライアンスポリシーを満たしているデバイス。
            * **ハイブリッド Azure AD 参加済みデバイスを要求する (Require Hybrid Azure AD joined device)**: オンプレミスADとEntra IDの両方に参加しているデバイス。
            * **承認済みクライアントアプリを必須とする (Require approved client app)**: Microsoftが承認した特定のモバイルアプリ（Intuneアプリ保護ポリシーと連携）。
            * **アプリ保護ポリシーを必須とする (Require app protection policy)**: Intuneアプリ保護ポリシーが適用されているアプリ。
            * **パスワードの変更を要求する**: リスクが検出された場合など。
            * **利用規約に同意する事を要求する**: 特定のアプリ利用前に同意を求める。
        * 複数の制御を選択した場合、「すべての選択されたコントロールが必要」または「選択されたコントロールのいずれかが必要」を指定できます。
    * **ブロックアクセス (Block access)**: アクセスを完全に拒否します。最も強力な制御であり、慎重に使用します。
* **セッション制御 (Session Controls)**: アクセスが許可された後のセッション内での動作を制御します。
    * **Microsoft Defender for Cloud Apps を使用する**: Defender for Cloud Appsと連携し、条件付きアクセスアプリ制御を適用（リアルタイム監視、ダウンロードブロックなど）。
    * **サインイン頻度 (Sign-in frequency)**: ユーザーが再度サインインを求められるまでの時間（例: 8時間ごと）。
    * **永続的なブラウザーセッション (Persistent browser session)**: ブラウザーを閉じてもサインイン状態を維持するかどうか。
    * **認証セッション管理のカスタマイズ (Custom authentication session management)**: (プレビュー機能) より詳細なセッショントークンの有効期間制御。
    * **継続的アクセス評価 (Continuous Access Evaluation - CAE)**: (一部条件下で自動有効) トークンの有効期間中でも、重要なイベント（パスワード変更、アカウント無効化など）が発生した場合にリアルタイムでアクセスを取り消します。
    * `[スクリーンショット：条件付きアクセスポリシーのアクセス制御とセッション制御の設定画面]`

### 一般的な条件付きアクセスポリシーのシナリオと作成手順

* **ポリシー作成のベストプラクティス**:
    * **命名規則**: ポリシーの目的がわかる明確な名前を付ける（例: `CA001: All Users - All Cloud Apps - Require MFA`）。
    * **少量から開始**: まずは影響の少ないユーザーグループやアプリでテストします。
    * **除外設定の活用**: 緊急時の管理者アクセス用アカウント（Break-glass account）やサービスアカウントなど、ポリシー対象外とすべきアカウントを除外リストに必ず追加します。
    * **What If ツールの利用**: ポリシー展開前に、特定のユーザーや条件下での影響をシミュレーションします。
    * **レポート専用モード (Report-only mode)**: ポリシーを実際に適用せず、影響をログで監視するモード。本番適用前の検証に非常に有効です。
    * **ドキュメント化**: 作成したポリシーの目的、設定内容、影響範囲を記録しておきます。
* **シナリオ1: すべてのユーザーにすべてのクラウドアプリへのアクセス時にMFAを要求する (基本ポリシー)**
    1.  Microsoft Entra 管理センター > `[保護]` > `[条件付きアクセス]` > `[ポリシー]` > `[+ 新しいポリシー]`。
    2.  **名前**: 例: `CA001: All Users - All Cloud Apps - Require MFA`
    3.  **割り当て - ユーザー**:
        * `[含める]`タブ: `[すべてのユーザー]` を選択。
        * `[除外]`タブ: 緊急アクセス用管理者アカウントや特定のサービスアカウントを除外。
    4.  **割り当て - ターゲットリソース**:
        * `[クラウド アプリ]` を選択。
        * `[含める]`タブ: `[すべてのクラウド アプリ]` を選択。
    5.  **アクセス制御 - 許可**:
        * `[アクセス権の付与]` を選択。
        * `[多要素認証を要求する]` にチェック。
        * `[選択]` をクリック。
    6.  **ポリシーの有効化**: `[オン]` を選択（テスト時は `[レポート専用]` から開始）。
    7.  `[作成]` をクリック。
* **シナリオ2: 管理者ロールを持つユーザーがAzure portal (Microsoft Azure Management) にアクセスする際にMFAを要求する**
    1.  新しいポリシーを作成。名前: 例: `CA002: Admins - Azure Portal - Require MFA`
    2.  **割り当て - ユーザー**:
        * `[含める]`タブ: `[ディレクトリ ロール]` を選択し、「グローバル管理者」「セキュリティ管理者」などの対象ロールを選択。
        * `[除外]`タブ: 緊急アクセス用管理者アカウント。
    3.  **割り当て - ターゲットリソース**:
        * `[クラウド アプリ]` を選択。
        * `[含める]`タブ: `[アプリの選択]` から「Microsoft Azure Management」を選択 (3つのアプリが表示される場合があるが、通常は `Microsoft Azure Management (API)` を含むものを指す)。
    4.  **アクセス制御 - 許可**: `[多要素認証を要求する]`。
    5.  ポリシーを有効化して作成。
* **シナリオ3: 信頼されていない場所 (社外など) からのアクセス時にMFAを要求する**
    1.  新しいポリシーを作成。名前: 例: `CA003: All Users - Untrusted Locations - Require MFA`
    2.  **割り当て - ユーザー**: `[すべてのユーザー]` (緊急アクセスアカウントは除外)。
    3.  **割り当て - ターゲットリソース**: `[すべてのクラウド アプリ]`。
    4.  **割り当て - 条件 - 場所**:
        * `[構成します]` を `[はい]` に設定。
        * `[含める]`タブ: `[任意の場所]` を選択。
        * `[除外]`タブ: `[すべての信頼できる場所]` (事前に「名前付き場所」で社内ネットワークなどを定義しておく) を選択。
            * `[スクリーンショット：場所の条件設定画面]`
    5.  **アクセス制御 - 許可**: `[多要素認証を要求する]`。
    6.  ポリシーを有効化して作成。
* **シナリオ4: 準拠していないデバイスからのアクセスをブロックする**
    1.  新しいポリシーを作成。名前: 例: `CA004: All Users - NonCompliant Devices - Block Access`
    2.  **割り当て - ユーザー**: `[すべてのユーザー]` (緊急アクセスアカウントは除外)。
    3.  **割り当て - ターゲットリソース**: `[すべてのクラウド アプリ]` (または特定の機密アプリ)。
    4.  **割り当て - 条件 - デバイスの状態 (レガシー)** または **フィルター処理されたデバイス (推奨)**:
        * **デバイスの状態 (レガシー)**: `[構成します]` を `[はい]` に設定。`[除外]` タブで `[準拠としてマークされているデバイス]` と `[ハイブリッド Azure AD 参加済みデバイス]` にチェックを入れる (つまり、これら以外のデバイスが対象となる)。
        * **フィルター処理されたデバイス (推奨)**: `[構成します]` を `[はい]` に設定。ルール構文を使用して `device.isCompliant -ne true` のように指定。
    5.  **アクセス制御 - 許可**: `[アクセス権のブロック]` を選択。
    6.  ポリシーを有効化して作成。**注意: このポリシーは影響が大きいため、レポート専用モードで十分にテストしてください。**
* **What If ツールの使い方**:
    1.  条件付きアクセスのポリシー一覧画面で `[What If]` をクリック。
    2.  評価したいユーザー、IPアドレス、デバイス、アプリケーションなどを指定します。
    3.  `[What If]` ボタンをクリックすると、その条件下でどのポリシーが適用され、どのような結果になるかが表示されます。
        * `[スクリーンショット：What Ifツールの結果表示画面]`

### 名前付き場所 (Named Locations) の構成

* **目的**: IPアドレス範囲や国/地域に基づいて、ポリシーで参照できる「場所」を定義します。
* **種類**:
    * **信頼できるIPアドレス**: 組織の社内ネットワークやVPN出口のパブリックIPアドレス範囲を指定します。これらの場所からのアクセスはMFAを免除するなどのポリシーに利用できます。
    * **国/地域**: GPSまたはIPアドレスに基づいて特定の国や地域を指定します。特定の国からのアクセスをブロックしたり、逆に特定の国からのみアクセスを許可したりするポリシーに利用できます。
* **構成手順 (Microsoft Entra 管理センター)**:
    1.  `[保護]` > `[条件付きアクセス]` > `[名前付き場所]` を選択。
    2.  `[+ IP範囲の場所]` または `[+ 国の場所]` をクリック。
        * `[スクリーンショット：名前付き場所の作成画面 (IP範囲と国)]`
    3.  **IP範囲の場所**: 名前、IP範囲（CIDR形式）、`[信頼できる場所としてマークする]` のチェック。
    4.  **国の場所**: 名前、対象国を選択（GPSまたはIPアドレスで決定）。
    5.  作成します。

### Microsoft Entra ID Protection とは？ (再掲と深掘り)

* **目的**: Microsoftの膨大な脅威インテリジェンスを活用し、IDベースの侵害リスクを自動的に検出、調査、修復する機能です。
* **検出するリスクの種類**:
    * **サインインリスク (Sign-in Risk)**: 個々のサインイン試行の異常性を評価します。
        * 例: 匿名IPアドレスからのサインイン、通常とは異なる場所からのサインイン、マルウェアに感染したデバイスからのサインイン、パスワードスプレー攻撃の試行。
    * **ユーザーリスク (User Risk)**: ユーザーアカウント自体が侵害されている可能性を評価します。
        * 例: 漏洩した資格情報（ダークウェブなどで発見されたもの）、通常とは異なるユーザーアクティビティ。
* **リスクレベル**: 低、中、高の3段階で評価されます。
* **ダッシュボード**: `[保護]` > `[ID 保護]` > `[概要]` でリスクの状況を把握できます。
    * `[スクリーンショット：ID Protection の概要ダッシュボード]`

### ID Protection ポリシーの構成

* **ポリシーの種類**:
    * **ユーザーリスクポリシー (User risk policy)**:
        * **対象**: ユーザーリスクレベルが特定の値（例: 中以上）に達したユーザー。
        * **制御**:
            * アクセスのブロック。
            * アクセスの許可 + パスワードの変更を要求（セキュアなパスワードリセット）。
        * `[スクリーンショット：ユーザーリスクポリシーの設定画面]`
    * **サインインリスクポリシー (Sign-in risk policy)**:
        * **対象**: サインインリスクレベルが特定の値（例: 中以上）に達したサインイン試行。
        * **制御**:
            * アクセスのブロック。
            * アクセスの許可 + 多要素認証を要求。
        * `[スクリーンショット：サインインリスクポリシーの設定画面]`
    * **MFA登録ポリシー (MFA registration policy)**: (現在は条件付きアクセスでのMFA登録促進が推奨される傾向)
        * ユーザーにMFA登録を促すポリシー。
* **設定のポイント**:
    * **対象ユーザー**: ポリシーを全ユーザーに適用するか、特定のグループに適用するか。
    * **リスクレベルのしきい値**: どのリスクレベルでアクションをトリガーするか。
    * **制御アクション**: ブロック、MFA要求、パスワード変更要求など。
    * **自己修復**: ユーザーがMFAやパスワード変更を行うことで、リスク状態を自動的に解消できるようにすることが重要です。
* **通知**: リスクが検出された際やポリシーがトリガーされた際に、ユーザーや管理者に通知するように設定できます。
* **レポート**: リスクのあるユーザー、リスクのあるサインイン、リスク検出の詳細なレポートを確認できます。

### アクセスレビューの構成と管理

* **目的**: グループメンバーシップ、エンタープライズアプリケーションへのアクセス権、Entra IDロールの割り当てなどが、依然として適切であるかを定期的にレビュー（棚卸し）し、不要なアクセス権を排除することで、セキュリティリスクを低減します。
* **レビュー対象**:
    * Microsoft 365 グループ、セキュリティグループのメンバー。
    * エンタープライズアプリケーションへのユーザー割り当て。
    * Entra ID のディレクトリロール。
    * PIMでのロールの適格な割り当て。
    * アクセスパッケージの割り当て。
* **作成手順 (Microsoft Entra 管理センター)**:
    1.  `[ID ガバナンス]` > `[アクセスレビュー]` を選択。
    2.  `[+ 新しいアクセスレビュー]` をクリック。
    3.  **レビューする内容を選択**: 例: `[チームとグループ]` または `[アプリケーション]`。
    4.  **スコープの選択**:
        * グループの場合: すべてのグループ、または特定のグループ。メンバーシップの種類（ゲストのみ、すべてのメンバー）。
        * アプリケーションの場合: 特定のアプリケーション。
    5.  **レビュー担当者**:
        * グループの所有者。
        * 選択したユーザーまたはグループ。
        * ユーザー自身 (セルフレビュー)。
        * マネージャー。
    6.  **頻度**: 1回限り、週単位、月単位、四半期ごと、年2回、年単位。
    7.  **期間**: レビューの開始日と終了日（または継続期間）。
    8.  **設定**:
        * **レビュー結果が適用されない場合のアクション**: アクセス権を削除、変更を推奨など。
        * **自動適用**: レビュー期間終了時に、承認されなかったアクセス権を自動的に削除するかどうか。
        * **レビュー担当者への通知**: レビュー開始時やリマインダー。
        * **追加コンテンツ**: レビュー担当者への指示など。
    9.  名前と説明を入力し、作成します。
        * `[スクリーンショット：アクセスレビューの作成ウィザードの主要ステップ]`
* **レビューの実行**:
    * レビュー担当者には、レビューが必要な項目が通知され、My Accessポータル (`myaccess.microsoft.com`) などからレビューを実施します。
    * 各アクセス権に対して「承認」「拒否」「不明」を選択し、理由を記述できます。
* **結果の確認と適用**: 管理者はアクセスレビューの進捗と結果を確認し、必要に応じて手動でアクションを適用したり、自動適用を監視したりします。

### 認証強度 (Authentication Strength) の活用

* **目的**: 条件付きアクセスポリシーで、特定のMFA方法の組み合わせ（特にフィッシング耐性のあるもの）を要求できるようにします。
* **組み込みの認証強度**:
    * 多要素認証 (基本的なMFA)
    * パスワードレスMFA (FIDO2, Windows Hello for Business, パスワードレス電話サインイン)
    * フィッシング耐性のあるMFA (FIDO2, Windows Hello for Business, 証明書ベース認証)
* **カスタム認証強度の作成**: 組織の要件に合わせて、許可するMFA方法の組み合わせを独自に定義できます。
* **条件付きアクセスポリシーでの利用**:
    * アクセス制御の「許可」で、「認証強度の要求」を選択し、定義済みの認証強度を指定します。
    * **シナリオ**: 機密性の高いアプリケーションへのアクセスや、管理者ロールを持つユーザーに対して、フィッシング耐性のあるMFAを強制する。
    * `[スクリーンショット：条件付きアクセスでの認証強度要求設定]`

### ハンズオン演習アイデア

* **演習2.10: 基本的な条件付きアクセスポリシーの作成とテスト**
    1.  すべてのユーザー（緊急用管理者アカウントを除く）が、Office 365 Exchange Onlineにアクセスする際にMFAを要求するポリシーを作成する。
    2.  まずは「レポート専用モード」で有効化し、サインインログでポリシーが期待通りに評価されるか（ただし適用はされない）を確認する。
    3.  その後、ポリシーを「オン」にし、テストユーザーでOutlook Web Appにアクセスし、MFAが要求されることを確認する。
* **演習2.11: What Ifツールの利用**
    1.  作成した条件付きアクセスポリシー（または複数のポリシー）がある状態で、What Ifツールを使用する。
    2.  特定のテストユーザー、特定のIPアドレス（社内と仮定した信頼できるIP、社外のIP）、特定のアプリケーションを指定し、どのポリシーが適用され、結果としてアクセスが許可されるか（MFA要求あり/なし）、またはブロックされるかを確認する。
* **演習2.12: 名前付き場所の作成とポリシーへの活用**
    1.  自組織の（またはテスト用の）パブリックIPアドレス範囲を「信頼できる場所」として名前付き場所に登録する。
    2.  新しい条件付きアクセスポリシーを作成し、「信頼できる場所」からのアクセスの場合にはMFAを要求しないが、それ以外の場所からのアクセスにはMFAを要求するように設定する（対象ユーザー、アプリは限定的に）。
* **演習2.13: ID Protectionポリシーの確認 (ライセンス依存)**
    * (P2ライセンス環境があれば) ユーザーリスクポリシーとサインインリスクポリシーのデフォルト設定を確認する。
    * リスクのあるユーザーやサインインのレポート画面で、どのような情報が確認できるかを見てみる。
* **演習2.14: アクセスレビューの作成 (グループメンバーシップ)**
    1.  テスト用のMicrosoft 365 グループを作成し、複数のテストユーザーをメンバーとして追加する。
    2.  このグループのメンバーシップに対するアクセスレビューを作成する。レビュー担当者を自分自身（または別のテスト管理者アカウント）に設定し、頻度を「1回限り」で短い期間に設定する。
    3.  レビュー担当者としてMy Accessポータルにアクセスし、レビュー依頼が来ていることを確認し、各メンバーのアクセスを「承認」または「拒否」してみる。

---

## 2.4 外部IDとゲストアクセスの管理

### Microsoft Entra B2B コラボレーションの概要

* **B2B (Business-to-Business) とは**: 組織が、外部のパートナー、ベンダー、請負業者などのユーザー（ゲストユーザー）と安全にコラボレーションできるようにする機能です。
* **仕組み**:
    * ゲストユーザーは、自身の既存のID（他のEntra IDテナントのアカウント、Microsoftアカウント、Googleアカウント、またはワンタイムパスコード用のメールアドレス）を使用して、招待元の組織のリソースにアクセスします。
    * ゲストユーザーのアカウントは、招待元のEntra IDテナントに「ゲスト」として作成されますが、資格情報自体は元のIDプロバイダーが管理します。
* **メリット**:
    * 外部ユーザーのために新しいアカウントやパスワードを作成・管理する必要がない。
    * 外部ユーザーは使い慣れた資格情報でアクセスできる。
    * アクセス許可やセキュリティポリシーをゲストユーザーにも適用できる。

### ゲストユーザーの招待プロセス

* **招待方法**:
    * **直接招待**:
        * Microsoft Entra 管理センター: `[ID]` > `[ユーザー]` > `[すべてのユーザー]` > `[新しいユーザー]` > `[外部ユーザーの招待]`。
            * `[スクリーンショット：Entra管理センターからのゲスト招待画面]`
        * PowerShell: `New-MgInvitation` コマンドレット。
        * Microsoft Graph API。
    * **アプリケーションからの招待**: SharePoint Onlineのサイト共有、Teamsのチームへの追加、特定のエンタープライズアプリケーションへのアクセス割り当てなど、各サービスから直接ゲストを招待できます。
    * **セルフサービスサインアップ経由のゲスト招待**: (エンタイトルメント管理などで構成) 外部ユーザーがアクセスパッケージを要求し、承認されるとゲストとして招待されます。
* **招待メール**: ゲストユーザーには、招待元の組織名、招待者、アクセス先の情報などが記載された招待メールが送信されます。ユーザーはこのメール内のリンクをクリックして招待を承諾し、サインインします。
    * 招待メールの本文や件名は、ある程度カスタマイズ可能です。
* **承諾エクスペリエンス**: ゲストユーザーが招待を承諾する際の画面フロー。プライバシーポリシーへの同意などが含まれる場合があります。

### 外部コラボレーション設定の構成

* **アクセス場所**: Microsoft Entra 管理センター > `[外部ID]` > `[外部コラボレーション設定]`。
    * `[スクリーンショット：外部コラボレーション設定の主要項目画面]`
* **主要な設定項目**:
    * **ゲストユーザーのアクセス制限**:
        * **ゲストユーザーはメンバーと同じアクセス権を持つ (最も包括的)**: デフォルト。
        * **ゲストユーザーは、自分のディレクトリ オブジェクトのプロパティとメンバーシップへのアクセスが制限される**: より制限的。
        * **ゲストユーザーのアクセスは、自分のディレクトリ オブジェクトのプロパティとメンバーシップに制限される (最も制限的)**: 最も厳しい。
    * **ゲスト招待の設定**:
        * **管理者はゲストを招待できる**: デフォルトでオン。
        * **メンバーはゲストを招待できる**: デフォルトでオン。組織のポリシーによりオフにすることも検討。
        * **ゲストはゲストを招待できる**: デフォルトでオフ。通常はオフのままが推奨。
        * **招待の送信にワンタイム パスコードを使用する**: メールアドレスを持つユーザーが、MicrosoftアカウントやEntra IDアカウントを持っていなくても、一時的なパスコードで認証できるようにします（B2Bコラボレーションの対象を広げる）。
    * **コラボレーションの制限**:
        * 特定のドメインへの招待のみを許可または拒否する（許可リスト/拒否リスト形式）。
* **組織のポリシーに合わせてこれらの設定を調整することが重要です。**

### クロステナントアクセス設定 (Cross-tenant access settings)

* **目的**: 他のMicrosoft Entra組織との間のB2BコラボレーションおよびB2B直接接続（Teams共有チャネルなどで利用）に関する、より詳細な受信・送信アクセス制御を行います。
* **アクセス場所**: Microsoft Entra 管理センター > `[外部ID]` > `[クロステナントアクセス設定]`。
* **構成要素**:
    * **既定の設定**: すべての外部Entra組織に対するデフォルトのアクセス設定。
    * **組織ごとの設定**: 特定の外部Entra組織（パートナー企業など）に対して、既定とは異なる個別の設定を構成できます。
* **受信アクセス設定 (Inbound access)**: 他のEntra組織のユーザーが、自組織のリソースにアクセスする際の制御。
    * B2Bコラボレーション: 外部ユーザーが自組織にどのように招待され、アクセスできるか。
    * B2B直接接続: 外部ユーザーが共有チャネルなどにどのようにアクセスできるか。
    * **信頼設定**: 外部テナントからのMFA要求やデバイス準拠状態を信頼するかどうか。これにより、外部ユーザーが自組織のポリシーを再度満たす必要がなくなる場合があります（利便性向上）。
        * `[スクリーンショット：クロステナントアクセス設定 - 受信信頼設定画面]`
* **送信アクセス設定 (Outbound access)**: 自組織のユーザーが、他のEntra組織のリソースにアクセスする際の制御。
    * B2Bコラボレーション: 自組織のユーザーが外部組織にゲストとしてどのようにアクセスできるか。
    * B2B直接接続: 自組織のユーザーが外部組織の共有チャネルなどにどのようにアクセスできるか。
    * 特定の外部ユーザーやグループ、アプリケーションへのアクセスを制限できます。
* **テナント制限 (Tenant Restrictions v2)**: (送信アクセスの一部として関連) 自組織のネットワークから、許可されていない外部Entraテナントへのアクセス（個人アカウントでのサインインなど）をブロックします。プロキシサーバーなどでの設定が必要です。
* **ユースケース**:
    * 緊密なパートナーシップを持つ企業Aと企業B間で、相互のMFAを信頼し、ユーザーがスムーズにコラボレーションできるようにする。
    * 特定の競合他社のテナントからのゲストアクセスをブロックする。

### エンタイトルメント管理による外部ユーザーのアクセス管理 (ID ガバナンスの一部)

* **目的**: グループ、アプリケーション、SharePointサイトへのアクセス権を「アクセスパッケージ」としてまとめ、内部ユーザーおよび外部ユーザー（ゲスト）がリクエストし、承認ワークフローを経て、期間限定でアクセスできるようにする仕組みです。ゲストユーザーのアクセスライフサイクル管理に有効です。
* **主要コンポーネント**:
    * **アクセスパッケージ**: リソース（グループ、アプリ、サイト）のコレクション。
    * **ポリシー**: 誰が（どの接続済み組織のユーザーが）アクセスパッケージをリクエストできるか、承認者、ライフサイクル（有効期限、アクセスレビュー）を定義。
    * **接続済み組織**: B2Bコラボレーションを行う外部のEntra IDテナントや他のIDプロバイダー。
* **ゲストユーザーへの適用**:
    * 外部ユーザーがMy Accessポータルから必要なアクセスパッケージをリクエスト。
    * 承認者がリクエストを承認すると、ゲストアカウントが自動的に作成（または既存アカウント利用）され、アクセス権が付与される。
    * 有効期限が切れるか、アクセスレビューで拒否されると、アクセス権が自動的に削除される。
* **メリット**: ゲストアクセスの申請、承認、棚卸しプロセスを自動化し、管理負担を軽減します。

### ハンズオン演習アイデア

* **演習2.15: ゲストユーザーの招待とアクセス体験**
    1.  個人のMicrosoftアカウント（または別の開発者テナントのユーザーアカウント）のメールアドレスを使用して、現在の開発者テナントにゲストユーザーとして招待する。
    2.  招待メールを受信し、承諾プロセスを完了する。
    3.  開発者テナントのMicrosoft Entra管理センターで、招待したゲストユーザーが「ゲスト」として表示されることを確認する。
    4.  そのゲストユーザーに、特定のSharePoint Onlineテストサイトへの読み取りアクセス許可を与えてみる。
    5.  ゲストユーザーとしてそのSharePointサイトにアクセスできることを確認する。
* **演習2.16: 外部コラボレーション設定の変更**
    1.  Microsoft Entra管理センターの外部コラボレーション設定で、「メンバーはゲストを招待できる」を一時的に「いいえ」に変更してみる（ただし、他の演習に影響しないよう注意し、必要なら元に戻す）。
    2.  その状態で、一般メンバー権限のテストユーザーでサインインし、ゲストを招待しようとしてもできないことを確認する（TeamsやSharePointから）。
* **演習2.17: クロステナントアクセス設定の確認 (概念理解)**
    * (実際の外部テナントとの連携設定は困難なため、ドキュメントベースで) クロステナントアクセス設定の「既定の設定」と「組織ごとの設定」の画面構成を確認する。
    * 「信頼設定」で、MFAやデバイス準拠を信頼するオプションがどのような意味を持つかを理解する。
* **演習2.18: (可能であればP2ライセンス環境で) アクセスパッケージの作成と外部ユーザーによるリクエスト体験**
    1.  テスト用のMicrosoft 365 グループを作成する。
    2.  このグループをリソースとするアクセスパッケージを作成する。
    3.  ポリシーで、「すべてのユーザー (ゲストを含む)」または「特定の接続済み組織のユーザー」がリクエストできるように設定し、承認者を自分自身に設定する。アクセス期間を短く設定する。
    4.  外部ユーザー（演習2.15で招待したゲストなど）としてMy Accessポータルにアクセスし、作成したアクセスパッケージをリクエストする。
    5.  承認者としてリクエストを承認し、ゲストユーザーがグループのメンバーになることを確認する。

---
